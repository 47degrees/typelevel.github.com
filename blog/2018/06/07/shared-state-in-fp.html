<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Typelevel.scala | Shared State in Functional Programming</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Let the Scala compiler work for you. We provide type classes, instances, conversions, testing, supplements to the standard library, and much more.">


    <link rel="mask-icon" href="/img/favicon-safari.svg" color="#F51C2B">
    <link href="/img/favicon.png" rel="icon" type="image/x-icon">
    <link rel="alternate" href="/blog/feed.rss" title="RSS feed" type="application/rss+xml">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">
    <link href='https://fonts.googleapis.com/css?family=Droid+Serif:400,400italic,700' rel='stylesheet' type='text/css'>

    <script type="text/javascript" src="/js/jquery.min.js"></script>
    <script type="text/javascript" src="/js/app.js"></script>
  </head>
  <body class="no-js ">
    <div class="header">
      <div class="wrapper">
        <a href="/">
          <div class="header__logo">
            Typelevel.scala
          </div>
        </a>
        <a href="#" class="header__menu">
          Menu
        </a>
        <ul class="navigation" role="navigation">
          <li >
            <a href="/projects/">Projects</a>
          </li>
          <li >
            <a href="/events/">Events</a>
          </li>
          <li  class="active" >
            <a href="/blog/">Blog</a>
          </li>
          <li >
            <a href="/about.html">About</a>
          </li>
        </ul>
      </div>
    </div>
    
    <div class="wrapper">
      <div class="content post js-fade-in">
  <h2>Shared State in Functional Programming</h2>

  <p>Newcomers to functional programming (FP) are often very confused about the proper way to share state without breaking purity and end up having a mix of pure and impure code that <a href="https://queue.acm.org/detail.cfm?id=2611829">defeats the purpose</a> of having pure FP code in the first place.</p>

<p>This is the reason that has motivated me to write a beginner friendly guide :)</p>

<h2 id="use-case">Use Case</h2>

<p>We have a program that runs three computations at the same time and updates the internal state to keep track of the
tasks that have been completed. When all the tasks are completed we request the final state and print it out.</p>

<p>You should get an output similar to the following one:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Starting process #1
Starting process #2
Starting process #3
  ... 3 seconds
Done #2
  ... 5 seconds
Done #1
  ... 10 seconds
Done #3
List(#2, #1, #3)
</code></pre></div></div>

<p>We’ll use the concurrency primitive <a href="https://typelevel.org/cats-effect/concurrency/ref.html"><code class="highlighter-rouge">Ref[IO, List[String]]</code></a> to represent our internal state because it’s a great fit.</p>

<h3 id="getting-started">Getting started</h3>

<p>So this is how we might decide to start writing our code having some knowledge about <a href="https://typelevel.org/cats-effect/datatypes/io.html"><code class="highlighter-rouge">cats.effect.IO</code></a>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect._</span>
<span class="k">import</span> <span class="nn">cats.effect.concurrent.Ref</span>
<span class="k">import</span> <span class="nn">cats.instances.list._</span>
<span class="k">import</span> <span class="nn">cats.syntax.all._</span>

<span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>

<span class="k">object</span> <span class="nc">sharedstate</span> <span class="k">extends</span> <span class="nc">IOApp</span> <span class="o">{</span>

  <span class="k">var</span> <span class="n">myState</span><span class="k">:</span> <span class="kt">Ref</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]]</span> <span class="k">=</span> <span class="k">_</span>

  <span class="k">def</span> <span class="n">putStrLn</span><span class="o">(</span><span class="n">str</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="n">println</span><span class="o">(</span><span class="n">str</span><span class="o">))</span>

  <span class="k">val</span> <span class="n">process1</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">putStrLn</span><span class="o">(</span><span class="s">"Starting process #1"</span><span class="o">)</span> <span class="o">*&gt;</span>
      <span class="nc">IO</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mf">5.</span><span class="n">seconds</span><span class="o">)</span> <span class="o">*&gt;</span>
      <span class="n">myState</span><span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="k">_</span> <span class="o">++</span> <span class="nc">List</span><span class="o">(</span><span class="s">"#1"</span><span class="o">))</span> <span class="o">*&gt;</span>
      <span class="n">putStrLn</span><span class="o">(</span><span class="s">"Done #1"</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">val</span> <span class="n">process2</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">putStrLn</span><span class="o">(</span><span class="s">"Starting process #2"</span><span class="o">)</span> <span class="o">*&gt;</span>
      <span class="nc">IO</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mf">3.</span><span class="n">seconds</span><span class="o">)</span> <span class="o">*&gt;</span>
      <span class="n">myState</span><span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="k">_</span> <span class="o">++</span> <span class="nc">List</span><span class="o">(</span><span class="s">"#2"</span><span class="o">))</span> <span class="o">*&gt;</span>
      <span class="n">putStrLn</span><span class="o">(</span><span class="s">"Done #2"</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">val</span> <span class="n">process3</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">putStrLn</span><span class="o">(</span><span class="s">"Starting process #3"</span><span class="o">)</span> <span class="o">*&gt;</span>
      <span class="nc">IO</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mf">10.</span><span class="n">seconds</span><span class="o">)</span> <span class="o">*&gt;</span>
      <span class="n">myState</span><span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="k">_</span> <span class="o">++</span> <span class="nc">List</span><span class="o">(</span><span class="s">"#3"</span><span class="o">))</span> <span class="o">*&gt;</span>
      <span class="n">putStrLn</span><span class="o">(</span><span class="s">"Done #3"</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">masterProcess</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">myState</span> <span class="k">=</span> <span class="nc">Ref</span><span class="o">.</span><span class="n">of</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]](</span><span class="nc">List</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">String</span><span class="o">]).</span><span class="n">unsafeRunSync</span><span class="o">()</span>
    <span class="k">val</span> <span class="n">ioa</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="n">process1</span><span class="o">,</span> <span class="n">process2</span><span class="o">,</span> <span class="n">process3</span><span class="o">).</span><span class="n">parSequence</span><span class="o">.</span><span class="n">void</span>
    <span class="n">ioa</span> <span class="o">*&gt;</span> <span class="n">myState</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="n">rs</span> <span class="k">=&gt;</span> <span class="n">putStrLn</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="n">toString</span><span class="o">))</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">run</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">ExitCode</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">masterProcess</span><span class="o">.</span><span class="n">as</span><span class="o">(</span><span class="nc">ExitCode</span><span class="o">.</span><span class="nc">Success</span><span class="o">)</span>

<span class="o">}</span>
</code></pre></div></div>

<p>We defined a <code class="highlighter-rouge">var myState: Ref[IO, List[String]]</code> initialized as <code class="highlighter-rouge">null</code> so we can create it on startup and all the child processes can have access to it. A so called <code class="highlighter-rouge">global state</code>.</p>

<p>But now we try to run our application and we encounter our first ugly problem: <code class="highlighter-rouge">NullPointerException</code> on line 19. All the processes are defined by using <code class="highlighter-rouge">myState</code> which has not yet been initialized. So an easy way to fix it is to define all our processes as <code class="highlighter-rouge">lazy val</code>.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">lazy</span> <span class="k">val</span> <span class="n">process1</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
<span class="k">lazy</span> <span class="k">val</span> <span class="n">process2</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
<span class="k">lazy</span> <span class="k">val</span> <span class="n">process3</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
</code></pre></div></div>

<p>That worked, brilliant! We have an application that meets the business criteria and most importantly it works!</p>

<h3 id="rethinking-our-application">Rethinking our application</h3>

<p>But let’s take a step back and review our code once again, there are at least two pieces of code that should have caught your attention:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">myState</span><span class="k">:</span> <span class="kt">Ref</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]]</span> <span class="k">=</span> <span class="k">_</span>
</code></pre></div></div>

<p>We are using <code class="highlighter-rouge">var</code> and initializing our state to <code class="highlighter-rouge">null</code>, OMG! Also the workaround of <code class="highlighter-rouge">lazy val</code> should get you thinking…</p>

<p>And here’s the second obvious one:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">myState</span> <span class="k">=</span> <span class="nc">Ref</span><span class="o">.</span><span class="n">of</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]](</span><span class="nc">List</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">String</span><span class="o">]).</span><span class="n">unsafeRunSync</span><span class="o">()</span>
</code></pre></div></div>

<p>We require our <code class="highlighter-rouge">myState</code> to be of type <code class="highlighter-rouge">Ref[IO, List[String]</code> but the smart constructor gives us an <code class="highlighter-rouge">IO[Ref[IO, List[String]]]</code> so we are “forced” to call <code class="highlighter-rouge">unsafeRunSync()</code> to get our desired type. And there’s a reason for that, the creation of a <code class="highlighter-rouge">Ref[F, A]</code> is side-effectful, therefore it needs to be wrapped in <code class="highlighter-rouge">IO</code> to keep the purity.</p>

<p>But wait a minute… that <code class="highlighter-rouge">unsafeRunSync()</code> is something that you should only see at the edge of your program, most commonly in the <code class="highlighter-rouge">main</code> method that is invoked by the <code class="highlighter-rouge">JVM</code> and that is impure by nature (of type <code class="highlighter-rouge">Unit</code>). But because we are using <code class="highlighter-rouge">IOApp</code> we shouldn’t be calling any operations which names are prefixed with <code class="highlighter-rouge">unsafe</code>.</p>

<p>You say to yourself, yes, I know this is bad and ugly but I don’t know a better way to share the state between different computations and this works. But we know you have heard that funcional programming is beautiful so why doing this?</p>

<h3 id="functional-programming">Functional Programming</h3>

<p>Okay, can we do better? Of course we do and you wouldn’t believe how simple it is!</p>

<p>Let’s get started by getting rid of that ugly <code class="highlighter-rouge">var myState</code> initialized to <code class="highlighter-rouge">null</code> and pass it as parameter to the processes that need to access it:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect._</span>
<span class="k">import</span> <span class="nn">cats.effect.concurrent.Ref</span>
<span class="k">import</span> <span class="nn">cats.instances.list._</span>
<span class="k">import</span> <span class="nn">cats.syntax.all._</span>

<span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>

<span class="k">object</span> <span class="nc">sharedstate</span> <span class="k">extends</span> <span class="nc">IOApp</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">putStrLn</span><span class="o">(</span><span class="n">str</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="n">println</span><span class="o">(</span><span class="n">str</span><span class="o">))</span>

  <span class="k">def</span> <span class="n">process1</span><span class="o">(</span><span class="n">myState</span><span class="k">:</span> <span class="kt">Ref</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]])</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">putStrLn</span><span class="o">(</span><span class="s">"Starting process #1"</span><span class="o">)</span> <span class="o">*&gt;</span>
      <span class="nc">IO</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mf">5.</span><span class="n">seconds</span><span class="o">)</span> <span class="o">*&gt;</span>
      <span class="n">myState</span><span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="k">_</span> <span class="o">++</span> <span class="nc">List</span><span class="o">(</span><span class="s">"#1"</span><span class="o">))</span> <span class="o">*&gt;</span>
      <span class="n">putStrLn</span><span class="o">(</span><span class="s">"Done #1"</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">process2</span><span class="o">(</span><span class="n">myState</span><span class="k">:</span> <span class="kt">Ref</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]])</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">putStrLn</span><span class="o">(</span><span class="s">"Starting process #2"</span><span class="o">)</span> <span class="o">*&gt;</span>
      <span class="nc">IO</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mf">3.</span><span class="n">seconds</span><span class="o">)</span> <span class="o">*&gt;</span>
      <span class="n">myState</span><span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="k">_</span> <span class="o">++</span> <span class="nc">List</span><span class="o">(</span><span class="s">"#2"</span><span class="o">))</span> <span class="o">*&gt;</span>
      <span class="n">putStrLn</span><span class="o">(</span><span class="s">"Done #2"</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">process3</span><span class="o">(</span><span class="n">myState</span><span class="k">:</span> <span class="kt">Ref</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]])</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">putStrLn</span><span class="o">(</span><span class="s">"Starting process #3"</span><span class="o">)</span> <span class="o">*&gt;</span>
      <span class="nc">IO</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mf">10.</span><span class="n">seconds</span><span class="o">)</span> <span class="o">*&gt;</span>
      <span class="n">myState</span><span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="k">_</span> <span class="o">++</span> <span class="nc">List</span><span class="o">(</span><span class="s">"#3"</span><span class="o">))</span> <span class="o">*&gt;</span>
      <span class="n">putStrLn</span><span class="o">(</span><span class="s">"Done #3"</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">masterProcess</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">myState</span><span class="k">:</span> <span class="kt">Ref</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Ref</span><span class="o">.</span><span class="n">of</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]](</span><span class="nc">List</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">String</span><span class="o">]).</span><span class="n">unsafeRunSync</span><span class="o">()</span>

    <span class="k">val</span> <span class="n">ioa</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="n">process1</span><span class="o">(</span><span class="n">myState</span><span class="o">),</span> <span class="n">process2</span><span class="o">(</span><span class="n">myState</span><span class="o">),</span> <span class="n">process3</span><span class="o">(</span><span class="n">myState</span><span class="o">)).</span><span class="n">parSequence</span><span class="o">.</span><span class="n">void</span>
    <span class="n">ioa</span> <span class="o">*&gt;</span> <span class="n">myState</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="n">rs</span> <span class="k">=&gt;</span> <span class="n">putStrLn</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="n">toString</span><span class="o">))</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">run</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">ExitCode</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">masterProcess</span><span class="o">.</span><span class="n">as</span><span class="o">(</span><span class="nc">ExitCode</span><span class="o">.</span><span class="nc">Success</span><span class="o">)</span>

<span class="o">}</span>
</code></pre></div></div>

<p>Great! We got rid of that <code class="highlighter-rouge">global state</code> and we are now passing our <code class="highlighter-rouge">Ref</code>as a parameter. Remember that it is a concurrency primitive meant to be accesed and modified in concurrent scenarios, so we are safe here.</p>

<p>Notice how all our processes are now defined as <code class="highlighter-rouge">def processN(myState: Ref[IO, List[String]])</code>.</p>

<h3 id="a-well-known-method-flatmap">A well known method: flatMap!</h3>

<p>Now, we still have that <code class="highlighter-rouge">unsafeRunSync()</code> hanging around our code, how can we get rid of it? The answer is <code class="highlighter-rouge">flatMap</code>!!!</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">masterProcess</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
  <span class="nc">Ref</span><span class="o">.</span><span class="n">of</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]](</span><span class="nc">List</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">String</span><span class="o">]).</span><span class="n">flatMap</span> <span class="o">{</span> <span class="n">myState</span> <span class="k">=&gt;</span>
    <span class="k">val</span> <span class="n">ioa</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="n">process1</span><span class="o">(</span><span class="n">myState</span><span class="o">),</span> <span class="n">process2</span><span class="o">(</span><span class="n">myState</span><span class="o">),</span> <span class="n">process3</span><span class="o">(</span><span class="n">myState</span><span class="o">)).</span><span class="n">parSequence</span><span class="o">.</span><span class="n">void</span>
    <span class="n">ioa</span> <span class="o">*&gt;</span> <span class="n">myState</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="n">rs</span> <span class="k">=&gt;</span> <span class="n">putStrLn</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="n">toString</span><span class="o">))</span>
  <span class="o">}</span>
</code></pre></div></div>

<p>You only need to call <code class="highlighter-rouge">flatMap</code> once up in the call chain where you call the processes to make sure they all share the same state. If you don’t do this, a new <code class="highlighter-rouge">Ref</code> will be created every time you <code class="highlighter-rouge">flatMap</code> (remember creating a <code class="highlighter-rouge">Ref</code> is side effectful!) and thus your processes will not be sharing the same state changing the behavior of your program.</p>

<p>We now have a purely functional code that shares state in a simple and pure fashion. Here’s the entire FP program:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect._</span>
<span class="k">import</span> <span class="nn">cats.effect.concurrent.Ref</span>
<span class="k">import</span> <span class="nn">cats.instances.list._</span>
<span class="k">import</span> <span class="nn">cats.syntax.all._</span>

<span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>

<span class="k">object</span> <span class="nc">sharedstate</span> <span class="k">extends</span> <span class="nc">IOApp</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">putStrLn</span><span class="o">(</span><span class="n">str</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="n">println</span><span class="o">(</span><span class="n">str</span><span class="o">))</span>

  <span class="k">def</span> <span class="n">process1</span><span class="o">(</span><span class="n">myState</span><span class="k">:</span> <span class="kt">Ref</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]])</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">putStrLn</span><span class="o">(</span><span class="s">"Starting process #1"</span><span class="o">)</span> <span class="o">*&gt;</span>
      <span class="nc">IO</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mf">5.</span><span class="n">seconds</span><span class="o">)</span> <span class="o">*&gt;</span>
      <span class="n">myState</span><span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="k">_</span> <span class="o">++</span> <span class="nc">List</span><span class="o">(</span><span class="s">"#1"</span><span class="o">))</span> <span class="o">*&gt;</span>
      <span class="n">putStrLn</span><span class="o">(</span><span class="s">"Done #1"</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">process2</span><span class="o">(</span><span class="n">myState</span><span class="k">:</span> <span class="kt">Ref</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]])</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">putStrLn</span><span class="o">(</span><span class="s">"Starting process #2"</span><span class="o">)</span> <span class="o">*&gt;</span>
      <span class="nc">IO</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mf">3.</span><span class="n">seconds</span><span class="o">)</span> <span class="o">*&gt;</span>
      <span class="n">myState</span><span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="k">_</span> <span class="o">++</span> <span class="nc">List</span><span class="o">(</span><span class="s">"#2"</span><span class="o">))</span> <span class="o">*&gt;</span>
      <span class="n">putStrLn</span><span class="o">(</span><span class="s">"Done #2"</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">process3</span><span class="o">(</span><span class="n">myState</span><span class="k">:</span> <span class="kt">Ref</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]])</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">putStrLn</span><span class="o">(</span><span class="s">"Starting process #3"</span><span class="o">)</span> <span class="o">*&gt;</span>
      <span class="nc">IO</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mf">10.</span><span class="n">seconds</span><span class="o">)</span> <span class="o">*&gt;</span>
      <span class="n">myState</span><span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="k">_</span> <span class="o">++</span> <span class="nc">List</span><span class="o">(</span><span class="s">"#3"</span><span class="o">))</span> <span class="o">*&gt;</span>
      <span class="n">putStrLn</span><span class="o">(</span><span class="s">"Done #3"</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">masterProcess</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Ref</span><span class="o">.</span><span class="n">of</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]](</span><span class="nc">List</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">String</span><span class="o">]).</span><span class="n">flatMap</span> <span class="o">{</span> <span class="n">myState</span> <span class="k">=&gt;</span>
      <span class="k">val</span> <span class="n">ioa</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="n">process1</span><span class="o">(</span><span class="n">myState</span><span class="o">),</span> <span class="n">process2</span><span class="o">(</span><span class="n">myState</span><span class="o">),</span> <span class="n">process3</span><span class="o">(</span><span class="n">myState</span><span class="o">)).</span><span class="n">parSequence</span><span class="o">.</span><span class="n">void</span>
      <span class="n">ioa</span> <span class="o">*&gt;</span> <span class="n">myState</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="n">rs</span> <span class="k">=&gt;</span> <span class="n">putStrLn</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="n">toString</span><span class="o">))</span>
    <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">run</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">ExitCode</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">masterProcess</span><span class="o">.</span><span class="n">as</span><span class="o">(</span><span class="nc">ExitCode</span><span class="o">.</span><span class="nc">Success</span><span class="o">)</span>

<span class="o">}</span>
</code></pre></div></div>

<h2 id="mutable-reference">Mutable reference</h2>

<p>As I mentioned in one of the sections above, the creation of <code class="highlighter-rouge">Ref[F, A]</code> is side-effectful. So what does this mean? Does it write to disk? Does it perform HTTP Requests? Not exactly.</p>

<p>It all comes down to wanting to keep the property of <em>referential transparency</em> while sharing and mutating state. So let’s again put up an example to follow up along with some explanation:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">a</span> <span class="k">=</span> <span class="mi">0</span>
<span class="k">def</span> <span class="n">set</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="n">a</span> <span class="k">=</span> <span class="n">n</span>
<span class="k">def</span> <span class="n">get</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="n">a</span>
</code></pre></div></div>

<p>Here we have imperative and impure code that mutates state. So we can try wrapping things in <code class="highlighter-rouge">IO</code> to keep side effects under control:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">IORef</span> <span class="o">{</span>
  <span class="k">var</span> <span class="n">a</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">def</span> <span class="n">set</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="n">a</span> <span class="k">=</span> <span class="n">n</span><span class="o">)</span>
  <span class="k">def</span> <span class="n">get</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">.</span><span class="n">pure</span><span class="o">(</span><span class="n">a</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>This is way better since now the mutation is encapsulated within <code class="highlighter-rouge">IORef</code> but we are now pushing some responsibility to whoever creates an <code class="highlighter-rouge">IORef</code>. Consider this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="n">ref</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">IORef</span><span class="o">()</span>
</code></pre></div></div>

<p>If we have two or more references to <code class="highlighter-rouge">ref</code> in our code, they will be referring to the same mutable state and we don’t really want that. We can make sure this doesn’t happen and a way to achieve this is to wrap the creation of <code class="highlighter-rouge">IORef</code> in <code class="highlighter-rouge">IO</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">class</span> <span class="nc">IORef</span> <span class="o">{</span>
  <span class="k">var</span> <span class="n">a</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">def</span> <span class="n">set</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="n">a</span> <span class="k">=</span> <span class="n">n</span><span class="o">)</span>
  <span class="k">def</span> <span class="n">get</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">.</span><span class="n">pure</span><span class="o">(</span><span class="n">a</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">IORef</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">IORef</span><span class="o">]</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="k">new</span> <span class="nc">IORef</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>We have now regained purity. So whenever you create an <code class="highlighter-rouge">IORef</code> you’ll get an <code class="highlighter-rouge">IO[IORef]</code> instead of a mutable reference to <code class="highlighter-rouge">IORef</code>. This means that when you invoke <code class="highlighter-rouge">flatMap</code> on it twice you’ll get two different mutable states, and this is the power of <code class="highlighter-rouge">Referential Transparency</code>. It gives you way more control than having a <code class="highlighter-rouge">val ref</code> hanging around in your code and gives you <strong><em>local reasoning</em></strong>.</p>

<p><em>All these examples are written in terms of <code class="highlighter-rouge">IO</code> for the sake of simplicity but in practice they are polymorphic on the effect type.</em></p>

<h2 id="applying-the-technique-in-other-libraries">Applying the technique in other libraries</h2>

<p>Although in the example above we only see how it’s done with the <code class="highlighter-rouge">cats-effect</code> library, this principle expands to other FP libraries as well.</p>

<p>For example, when writing an <code class="highlighter-rouge">http4s</code> application you might need to create an <code class="highlighter-rouge">HttpClient</code> that needs to be used by more than one of your services. So again, create it at startup and <code class="highlighter-rouge">flatMap</code> it once:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">HttpServer</span> <span class="k">extends</span> <span class="nc">StreamApp</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">stream</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span> <span class="n">requestShutdown</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">])</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">ExitCode</span><span class="o">]</span> <span class="k">=</span>
    <span class="k">for</span> <span class="o">{</span>
      <span class="n">httpClient</span> <span class="k">&lt;-</span> <span class="nc">Http1Client</span><span class="o">.</span><span class="n">stream</span><span class="o">[</span><span class="kt">IO</span><span class="o">]()</span>
      <span class="n">endpoint1</span>  <span class="k">=</span> <span class="k">new</span> <span class="nc">HttpEndpointOne</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="n">httpClient</span><span class="o">)</span>
      <span class="n">endpoint2</span>  <span class="k">=</span> <span class="k">new</span> <span class="nc">HttpEndpointTwo</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="n">httpClient</span><span class="o">)</span>
      <span class="n">exitCode</span>   <span class="k">&lt;-</span> <span class="nc">BlazeBuilder</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span>
                      <span class="o">.</span><span class="n">bindHttp</span><span class="o">(</span><span class="mi">8080</span><span class="o">,</span> <span class="s">"0.0.0.0"</span><span class="o">)</span>
                      <span class="o">.</span><span class="n">mountService</span><span class="o">(</span><span class="n">endpoint1</span><span class="o">)</span>
                      <span class="o">.</span><span class="n">mountService</span><span class="o">(</span><span class="n">endpoint2</span><span class="o">)</span>
                      <span class="o">.</span><span class="n">serve</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="n">exitCode</span>

<span class="o">}</span>

<span class="k">class</span> <span class="nc">HttpEndpointOne</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">client</span><span class="k">:</span> <span class="kt">Client</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
<span class="k">class</span> <span class="nc">HttpEndpointTwo</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">client</span><span class="k">:</span> <span class="kt">Client</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
</code></pre></div></div>

<p>When writing <code class="highlighter-rouge">fs2</code> applications you can apply the same technique, for example between processes that share a <code class="highlighter-rouge">Queue</code>, <code class="highlighter-rouge">Topic</code>, <code class="highlighter-rouge">Signal</code>, <code class="highlighter-rouge">Semaphore</code>, etc.</p>

<p>Remember that if you are forced to call <code class="highlighter-rouge">unsafeRunSync()</code> other than in your <code class="highlighter-rouge">main</code> method it might be a <em>code smell</em>.</p>

<h2 id="conclusion">Conclusion</h2>

<p>To conclude this post I would like to give a big shout out to <a href="https://github.com/SystemFw">@SystemFW</a> who has been untiringly teaching this concept in the Gitter channels. And here’s a quote from his response on <a href="https://www.reddit.com/r/scala/comments/8ofc8j/shared_state_in_pure_functional_programming_github/e050wy2/">Reddit</a>:</p>

<blockquote>
  <p>At the end of the day all the benefits from <em>referential transparency</em> boil down to being able to understand and build code compositionally. That is, understanding code by understanding individual parts and putting them back together, and building code by building individual parts and combining them together. This is only possible if <em>local reasoning</em> is guaranteed, because otherwise there will be weird interactions when you put things back together, and referential transparency is <em>defined</em> as something that guarantees local reasoning.</p>
</blockquote>

<blockquote>
  <p>In the specific case of state sharing, this gives rise to a really nice property: since the only way to share is passing things as an argument, <em>the regions of sharing are exactly the same of your call graph</em>, so you transform an important aspect of the behaviour (“who shares this state?”) into a straightforward syntactical property (“what methods take this argument”?). This makes shared state in pure FP a lot easier to reason about than its side-effectful counterpart imho.</p>
</blockquote>

<p>In simple terms, remind yourself about this: <strong>“flatMap once and pass the reference as an argument!”</strong></p>


<h2>Licensing</h2>
<p>
  Unless otherwise noted, all content is licensed under a <a href="https://creativecommons.org/licenses/by/3.0/deed.en_US">Creative Commons Attribution 3.0 Unported License</a>.
</p>


  <div class="post__author js-fade-in">
    
    
      
        <img class="portrait" src="/img/media/speakers/gvolpe.jpg" />
      
      <p>by Gabriel Volpe
    
    on Jun 07, 2018</p>

    
  <a href="https://twitter.com/volpegabriel87" class="twitter-follow-button" data-show-count="false" data-dnt="true">Follow @volpegabriel87</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


  <a class="github-button" href="https://github.com/gvolpe" aria-label="Follow @gvolpe on GitHub">Follow @gvolpe</a>
  <script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>


  </div>
  <a class="btn text" href="/blog">Back to blog</a>

  <br style="clear:both;">
<div class="disqus-container" style="padding-top:1em;">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'typelevel'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

</div>



    </div>

    <div class="footer">
      <div class="wrapper">
        <p>Copyright &copy; 2013-2018 the <a href="/">typelevel.org</a> <a href="/contributors.html">contributors</a>.</p>
        <ul class="navigation">
          <li><a href="/projects">Projects</a></li>
          <li><a href="/events">Events</a></li>
          <li><a href="/blog">Blog</a></li>
          <li><a href="/about">About</a></li>
        </ul>
      </div>
    </div>
    
  <!-- Salvattore.js for the masonry layout -->
  <script type="text/javascript" src="/js/salvattore.min.js"></script>
  <!-- Salvattore.js for the masonry layout -->
  </body>
</html>
