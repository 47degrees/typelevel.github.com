<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Typelevel.scala | Testing in the wild</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Let the Scala compiler work for you. We provide type classes, instances, conversions, testing, supplements to the standard library, and much more.">


    <link rel="mask-icon" href="/img/favicon-safari.svg" color="#F51C2B">
    <link href="/img/favicon.png" rel="icon" type="image/x-icon">
    <link rel="alternate" href="/blog/feed.rss" title="RSS feed" type="application/rss+xml">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">
    <link href='https://fonts.googleapis.com/css?family=Droid+Serif:400,400italic,700' rel='stylesheet' type='text/css'>

    <script type="text/javascript" src="/js/jquery.min.js"></script>
    <script type="text/javascript" src="/js/app.js"></script>
  </head>
  <body class="no-js ">
    <div class="header">
      <div class="wrapper">
        <a href="/">
          <div class="header__logo">
            Typelevel.scala
          </div>
        </a>
        <a href="#" class="header__menu">
          Menu
        </a>
        <ul class="navigation" role="navigation">
          <li >
            <a href="/projects/">Projects</a>
          </li>
          <li >
            <a href="/events/">Events</a>
          </li>
          <li  class="active" >
            <a href="/blog/">Blog</a>
          </li>
          <li >
            <a href="/about.html">About</a>
          </li>
        </ul>
      </div>
    </div>
    
    <div class="wrapper">
      <div class="content post js-fade-in">
  <h2>Testing in the wild</h2>

  <p>Writing tests seems like a wonderful idea in theory but real systems can be a real pain to test. Today I want to show a few tips on how to
 use <a href="http://specs2.org">specs2</a> + <a href="http://www.scalacheck.org">ScalaCheck</a> to make some real-world testing somewhat bearable.</p>

<p>I am currently refactoring a big piece of code. Such refactoring is more like a small rewrite and some of our previous tests also have to be
 rewritten from scratch. I will try to introduce you to the problem first.</p>

<h3 id="creating-articles">Creating articles</h3>

<p>The system-du-jour is called “Panda” (we have animal names for many of our services in my team) and is tasked with the creation of articles
 on our legacy platform. An article is already a complicated beast. We have 3 levels of descriptions:</p>

<ul>
  <li>Model: the description for a pair of RunFast shoes, with the brand, the gender it applies to, the size chart it uses and so on</li>
  <li>Config: the description for a specific combination of colours - black RunFast -, images, material,… There can be several configs per model</li>
  <li>Simple: the description of a specific size - 37, 38, 39 -, price, stock, EAN (European Article Number),… There can be several simples
  per config</li>
</ul>

<p>This data can be created in our legacy catalog by calling a bunch of SOAP (yes you read that right) APIs and getting back, at each level,
  some identifiers for the model, the configs, the simples.</p>

<p>This in itself can already be quite complicated and the creation of an article could fail in many ways. But it gets a lot more complex
  considering that:</p>

<ol>
  <li>
    <p>we need the service to be idempotent and not try to recreate an existing model/config/simple twice if we receive the same event twice
(we are using Kafka as our events system)</p>
  </li>
  <li>
    <p>the articles sent by a merchant can be created incrementally, so some parts of the model/config/simple might have been already created
in a previous call</p>
  </li>
  <li>
    <p>we are not the only ones creating articles in the system! Indeed, our team creates articles coming from external merchants but there is
also an internal “wholesale” department buying their own articles and creating them in the catalog. In that case a merchant might add
a new config to an existing model or some simples to an existing config</p>
  </li>
  <li>
    <p>any step in the process could break and we have no support for transactions making sure that everything is created at once</p>
  </li>
</ol>

<p>So many things which can go wrong, how would you go about testing it?</p>

<h3 id="combinations-the-key-to-testing">Combinations, the key to testing</h3>

<p>After I started rewriting the tests I realized that our current approach was barely scratching the surface of all the possible combinations.
 In a similar case your first thought should be “ScalaCheck”! But this time I am going to use ScalaCheck with a twist. Instead of only modelling
 input data (model/config/simples) I am also modelling the system state:</p>

<ul>
  <li>we have a “mapping table” to store merchant articles that have already been created. In which states can it be?</li>
  <li>the legacy catalog can also be in many different states: does a particular model/config/simple already exist or not?</li>
</ul>

<p>If we translate this into a specs2 + ScalaCheck specification, we get a property like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ArticleServiceSpec</span> <span class="k">extends</span> <span class="nc">Specification</span> <span class="k">with</span> <span class="nc">ScalaCheck</span> <span class="o">{</span> <span class="k">def</span> <span class="n">is</span> <span class="k">=</span> <span class="n">s2</span><span class="s">"""

  &lt;insert long description of the problem and what we want to test&gt;

  run tests for model creation $modelCreation

"""</span>

  <span class="k">def</span> <span class="n">modelCreation</span> <span class="k">=</span> <span class="n">prop</span> <span class="o">{</span> <span class="o">(</span><span class="n">reviewed</span><span class="k">:</span> <span class="kt">Article</span><span class="o">,</span> <span class="n">catalog</span><span class="k">:</span> <span class="kt">TestCatalog</span><span class="o">,</span> <span class="n">mappings</span><span class="k">:</span> <span class="kt">TestMappings</span><span class="o">)</span> <span class="k">=&gt;</span>

    <span class="n">ok</span> <span class="c1">// for now
</span>

  <span class="o">}.</span><span class="n">setGen1</span><span class="o">(</span><span class="n">genArticleOneConfig</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>We are creating a ScalaCheck property, with a specs2 method <code class="highlighter-rouge">prop</code> which gives us some additional power over row ScalaCheck properties.
 One thing we do here is to restrict the kind of generated <code class="highlighter-rouge">Article</code> to articles containing only one new configuration because we want to
  focus first on all the possible cases of model creation. So we pass a specific generator to the property, just for the first argument
  with <code class="highlighter-rouge">setGen1</code>.</p>

<p>Then, as you can see above, we return <code class="highlighter-rouge">ok</code> which is a specs2 result. This is because <code class="highlighter-rouge">prop</code> allows us to return anything that specs2 recognizes
  as a <code class="highlighter-rouge">Result</code> (with the <code class="highlighter-rouge">org.specs2.execute.AsResult</code> typeclass) and then we are not limited to booleans in our ScalaCheck properties but
  we can use specs2 matchers as well (we are going use this in the next step).</p>

<p>Now, for testing we need to do the following:</p>

<ol>
  <li>capture the state before the article creation</li>
  <li>execute the article creation</li>
  <li>capture the state after the article creation</li>
  <li>compare the resulting state to expected values</li>
</ol>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">val</span> <span class="n">before</span> <span class="k">=</span> <span class="n">createBeforeState</span><span class="o">(</span><span class="n">reviewed</span><span class="o">,</span> <span class="n">catalog</span><span class="o">,</span> <span class="n">mappings</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">run</span><span class="o">(</span><span class="n">createService</span><span class="o">(</span><span class="n">catalog</span><span class="o">,</span> <span class="n">mappings</span><span class="o">).</span><span class="n">createArticles</span><span class="o">[</span><span class="kt">R</span><span class="o">](</span><span class="n">reviewed</span><span class="o">))</span>
  <span class="k">val</span> <span class="n">after</span>  <span class="k">=</span> <span class="n">createAfterState</span><span class="o">(</span><span class="n">reviewed</span><span class="o">,</span> <span class="n">catalog</span><span class="o">,</span> <span class="n">mappings</span><span class="o">,</span> <span class="n">result</span><span class="o">)</span>
</code></pre></div></div>

<p>What are <code class="highlighter-rouge">BeforeState</code> and <code class="highlighter-rouge">AfterState</code>? They are custom case classes modelling the variables we are interested in:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">case</span> <span class="k">class</span> <span class="nc">BeforeState</span><span class="o">(</span>
   <span class="n">modelIdProvided</span><span class="k">:</span>       <span class="kt">Boolean</span><span class="o">,</span>
   <span class="n">modelNeedsToBeCreated</span><span class="k">:</span> <span class="kt">Boolean</span><span class="o">,</span>
   <span class="n">modelExistsInCatalog</span><span class="k">:</span>  <span class="kt">Boolean</span><span class="o">,</span>
   <span class="n">mappingExists</span><span class="k">:</span>         <span class="kt">Boolean</span><span class="o">)</span>

 <span class="k">case</span> <span class="k">class</span> <span class="nc">AfterState</span><span class="o">(</span>
   <span class="n">modelExistsInCatalog</span><span class="k">:</span> <span class="kt">Boolean</span><span class="o">,</span>
   <span class="n">mappingExists</span><span class="k">:</span>        <span class="kt">Boolean</span><span class="o">,</span>
   <span class="n">exception</span><span class="k">:</span>            <span class="kt">Option</span><span class="o">[</span><span class="kt">Throwable</span><span class="o">])</span>
</code></pre></div></div>

<p>The first 2 variables of <code class="highlighter-rouge">BeforeState</code> are a bit curious. The first one gives us a <code class="highlighter-rouge">ModelId</code> if upstream systems know that a model already
  exist. Then how could <code class="highlighter-rouge">modelNeedsToBeCreated</code> be true? Well, the events we receive don’t rule out this possibility. This is the
  current state of our domain data and arguably we should model things differently and reject malformed events right away. This is where the
  saying <a href="https://www.obeythetestinggoat.com/book/chapter_purist_unit_tests.html#_listen_to_your_tests_ugly_tests_signal_a_need_to_refactor">“Listen to your tests”</a> comes in :-).</p>

<p>If we count the number of combinations we end up with 16 possibilities for our “before state” and 8 possible outcomes. How can we represent
   all those combinations in our test?</p>

<h3 id="datatables">DataTables</h3>

<p>Specs2 offers to possibility to create tables of data directly inside the code for better readability of actual and expected values
 when you have lots of different possible combinations. Here is what we can do here</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">val</span> <span class="n">results</span> <span class="k">=</span>
  <span class="s">"#"</span> <span class="o">|</span> <span class="s">"model-id"</span> <span class="o">|</span> <span class="s">"create"</span> <span class="o">|</span> <span class="s">"in catalog"</span> <span class="o">|</span> <span class="s">"mapping"</span> <span class="o">||</span> <span class="s">"in catalog"</span>  <span class="o">|</span> <span class="s">"mapping"</span> <span class="o">|</span> <span class="s">"exception"</span> <span class="o">|</span> <span class="s">"comment"</span> <span class="o">|</span>
  <span class="mi">1</span>   <span class="o">!</span>  <span class="kc">true</span>      <span class="o">!</span> <span class="kc">true</span>     <span class="o">!</span> <span class="kc">true</span>         <span class="o">!</span> <span class="kc">true</span>      <span class="o">!!</span> <span class="kc">true</span>          <span class="o">!</span> <span class="kc">true</span>      <span class="o">!</span> <span class="kc">false</span>       <span class="o">!</span> <span class="s">"no model is created, because it can be found in the catalog, creation data is ignored"</span> <span class="o">|</span>
  <span class="mi">2</span>   <span class="o">!</span>  <span class="kc">true</span>      <span class="o">!</span> <span class="kc">true</span>     <span class="o">!</span> <span class="kc">true</span>         <span class="o">!</span> <span class="kc">false</span>     <span class="o">!!</span> <span class="kc">true</span>          <span class="o">!</span> <span class="kc">true</span>      <span class="o">!</span> <span class="kc">false</span>       <span class="o">!</span> <span class="s">"we just updated the mapping"</span> <span class="o">|</span>
  <span class="mi">3</span>   <span class="o">!</span>  <span class="kc">true</span>      <span class="o">!</span> <span class="kc">true</span>     <span class="o">!</span> <span class="kc">false</span>        <span class="o">!</span> <span class="kc">true</span>      <span class="o">!!</span> <span class="kc">false</span>         <span class="o">!</span> <span class="kc">true</span>      <span class="o">!</span> <span class="kc">true</span>        <span class="o">!</span> <span class="s">"the config creation must fail, no existing model"</span> <span class="o">|</span>
  <span class="mi">4</span>   <span class="o">!</span>  <span class="kc">true</span>      <span class="o">!</span> <span class="kc">true</span>     <span class="o">!</span> <span class="kc">false</span>        <span class="o">!</span> <span class="kc">false</span>     <span class="o">!!</span> <span class="kc">true</span>          <span class="o">!</span> <span class="kc">true</span>      <span class="o">!</span> <span class="kc">false</span>       <span class="o">!</span> <span class="s">"the given model-id is ignored (a warning is logged)"</span> <span class="o">|</span>
  <span class="mi">5</span>   <span class="o">!</span>  <span class="kc">true</span>      <span class="o">!</span> <span class="kc">false</span>    <span class="o">!</span> <span class="kc">true</span>         <span class="o">!</span> <span class="kc">true</span>      <span class="o">!!</span> <span class="kc">true</span>          <span class="o">!</span> <span class="kc">true</span>      <span class="o">!</span> <span class="kc">false</span>       <span class="o">!</span> <span class="s">"no model is created, because it can be found in the catalog"</span> <span class="o">|</span>
  <span class="mi">6</span>   <span class="o">!</span>  <span class="kc">true</span>      <span class="o">!</span> <span class="kc">false</span>    <span class="o">!</span> <span class="kc">true</span>         <span class="o">!</span> <span class="kc">false</span>     <span class="o">!!</span> <span class="kc">true</span>          <span class="o">!</span> <span class="kc">false</span>     <span class="o">!</span> <span class="kc">false</span>       <span class="o">!</span> <span class="s">"the mappings are not updated because we did not create the model"</span> <span class="o">|</span>
  <span class="mi">7</span>   <span class="o">!</span>  <span class="kc">true</span>      <span class="o">!</span> <span class="kc">false</span>    <span class="o">!</span> <span class="kc">false</span>        <span class="o">!</span> <span class="kc">true</span>      <span class="o">!!</span> <span class="kc">false</span>         <span class="o">!</span> <span class="kc">true</span>      <span class="o">!</span> <span class="kc">true</span>        <span class="o">!</span> <span class="s">"no corresponding model in the catalog"</span> <span class="o">|</span>
  <span class="mi">8</span>   <span class="o">!</span>  <span class="kc">true</span>      <span class="o">!</span> <span class="kc">false</span>    <span class="o">!</span> <span class="kc">false</span>        <span class="o">!</span> <span class="kc">false</span>     <span class="o">!!</span> <span class="kc">false</span>         <span class="o">!</span> <span class="kc">false</span>     <span class="o">!</span> <span class="kc">true</span>        <span class="o">!</span> <span class="s">"no corresponding model in the catalog"</span> <span class="o">|</span>
  <span class="mi">9</span>   <span class="o">!</span>  <span class="kc">false</span>     <span class="o">!</span> <span class="kc">true</span>     <span class="o">!</span> <span class="kc">true</span>         <span class="o">!</span> <span class="kc">true</span>      <span class="o">!!</span> <span class="kc">true</span>          <span class="o">!</span> <span class="kc">true</span>      <span class="o">!</span> <span class="kc">false</span>       <span class="o">!</span> <span class="s">"we use the mapping table to retrieve the model id and the catalog for the model"</span> <span class="o">|</span>
  <span class="mi">10</span>  <span class="o">!</span>  <span class="kc">false</span>     <span class="o">!</span> <span class="kc">true</span>     <span class="o">!</span> <span class="kc">true</span>         <span class="o">!</span> <span class="kc">false</span>     <span class="o">!!</span> <span class="kc">true</span>          <span class="o">!</span> <span class="kc">true</span>      <span class="o">!</span> <span class="kc">false</span>       <span class="o">!</span> <span class="s">"in this case the model already exists in the catalag but we have no way to know"</span> <span class="o">|</span>
  <span class="mi">11</span>  <span class="o">!</span>  <span class="kc">false</span>     <span class="o">!</span> <span class="kc">true</span>     <span class="o">!</span> <span class="kc">false</span>        <span class="o">!</span> <span class="kc">true</span>      <span class="o">!!</span> <span class="kc">false</span>         <span class="o">!</span> <span class="kc">true</span>      <span class="o">!</span> <span class="kc">true</span>        <span class="o">!</span> <span class="s">"the mapping exists but not the data in the catalog"</span> <span class="o">|</span>
  <span class="mi">12</span>  <span class="o">!</span>  <span class="kc">false</span>     <span class="o">!</span> <span class="kc">true</span>     <span class="o">!</span> <span class="kc">false</span>        <span class="o">!</span> <span class="kc">false</span>     <span class="o">!!</span> <span class="kc">true</span>          <span class="o">!</span> <span class="kc">true</span>      <span class="o">!</span> <span class="kc">false</span>       <span class="o">!</span> <span class="s">"regular model + config creation case"</span> <span class="o">|</span>
  <span class="mi">13</span>  <span class="o">!</span>  <span class="kc">false</span>     <span class="o">!</span> <span class="kc">false</span>    <span class="o">!</span> <span class="kc">true</span>         <span class="o">!</span> <span class="kc">true</span>      <span class="o">!!</span> <span class="kc">true</span>          <span class="o">!</span> <span class="kc">true</span>      <span class="o">!</span> <span class="kc">true</span>        <span class="o">!</span> <span class="s">"there is no model id and no creation data"</span> <span class="o">|</span>
  <span class="mi">14</span>  <span class="o">!</span>  <span class="kc">false</span>     <span class="o">!</span> <span class="kc">false</span>    <span class="o">!</span> <span class="kc">true</span>         <span class="o">!</span> <span class="kc">false</span>     <span class="o">!!</span> <span class="kc">true</span>          <span class="o">!</span> <span class="kc">false</span>     <span class="o">!</span> <span class="kc">true</span>        <span class="o">!</span> <span class="s">"the model exists in the catalog but we have no way to retrieve it"</span> <span class="o">|</span>
  <span class="mi">15</span>  <span class="o">!</span>  <span class="kc">false</span>     <span class="o">!</span> <span class="kc">false</span>    <span class="o">!</span> <span class="kc">false</span>        <span class="o">!</span> <span class="kc">true</span>      <span class="o">!!</span> <span class="kc">false</span>         <span class="o">!</span> <span class="kc">true</span>      <span class="o">!</span> <span class="kc">true</span>        <span class="o">!</span> <span class="s">"model id found in the mapping but not in the catalog"</span> <span class="o">|</span>
  <span class="mi">16</span>  <span class="o">!</span>  <span class="kc">false</span>     <span class="o">!</span> <span class="kc">false</span>    <span class="o">!</span> <span class="kc">false</span>        <span class="o">!</span> <span class="kc">false</span>     <span class="o">!!</span> <span class="kc">false</span>         <span class="o">!</span> <span class="kc">false</span>     <span class="o">!</span> <span class="kc">true</span>        <span class="o">!</span> <span class="s">"not enough data to create the model nor the mapping"</span>

 <span class="n">checkState</span><span class="o">(</span><span class="n">before</span><span class="o">,</span> <span class="n">after</span><span class="o">,</span> <span class="n">parseTable</span><span class="o">(</span><span class="n">results</span><span class="o">))</span>
</code></pre></div></div>
<p>This looks like a strange piece of code but this is actually all valid Scala syntax! <code class="highlighter-rouge">results</code> is a specs2 <code class="highlighter-rouge">DataTable</code> created out of:</p>

<ul>
  <li>a header where column names are separated with <code class="highlighter-rouge">|</code></li>
  <li>rows that are also separated with <code class="highlighter-rouge">|</code></li>
  <li>cells on each row, separated with <code class="highlighter-rouge">!</code></li>
</ul>

<p>We can also use <code class="highlighter-rouge">||</code> and <code class="highlighter-rouge">!!</code> as separators and we use this possibility here to visually distinguish input columns from expected results
  columns.</p>

<h3 id="running-the-tests">Running the tests</h3>

<p>The table above is like a big “truth table” for all our input conditions. Running a test consists in:</p>

<ol>
  <li>using the ‘before state’ to locate one of the row</li>
  <li>getting the expected ‘after state’ from the expected columns</li>
  <li>comparing the actual ‘after state’ with the expected one</li>
</ol>

<p>The funny thing is that before executing the test I did not exactly know what the code would actually do! So I just let the test guide me.
I put some expected values, run the test and in case of a failure, inspect the input values, think hard about why the code is not behaving the
way I think it should.</p>

<p>One question comes to mind: since this is a ScalaCheck property, how can we be sure we hit all the cases in the table? The first thing we
can do is to massively increase the number of tests that are going to be executed for this property, like 10000. With specs2 you have many
ways to do this. You can set the <code class="highlighter-rouge">minTestsOk</code> ScalaCheck property directly in the code:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">modelCreation</span> <span class="k">=</span> <span class="n">prop</span> <span class="o">{</span> <span class="o">(</span><span class="n">reviewed</span><span class="k">:</span> <span class="kt">Article</span><span class="o">,</span> <span class="n">catalog</span><span class="k">:</span> <span class="kt">TestCatalog</span><span class="o">,</span> <span class="n">mappings</span><span class="k">:</span> <span class="kt">TestMappings</span><span class="o">)</span> <span class="k">=&gt;</span>
 <span class="o">...</span>
<span class="o">}.</span><span class="n">setGen1</span><span class="o">(</span><span class="n">genArticleOneConfig</span><span class="o">).</span><span class="n">set</span><span class="o">(</span><span class="n">minTestsOk</span> <span class="k">=</span> <span class="mi">10000</span><span class="o">)</span>
</code></pre></div></div>

<p>But you can also do it from sbt:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sbt&gt; testOnly *ArticleServiceSpec -- scalacheck.mintestsok 10000
</code></pre></div></div>

<p>This is quite cool because this means that you don’t have to recompile the code if you just want to run a ScalaCheck property with more tests.</p>

<h3 id="checking-the-results">Checking the results</h3>

<p>As I wrote, when a specific combination would fail I had to inspect the inputs/outputs and think hard, maybe my expectations are wrong and
I needed to change the expected values? To this end I added a “line number” column to the table and reported it in the result:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> [error]  &gt; On line 6
 [error]
 [error]  Before
 [error]    model id set:             true
 [error]    model creation data set:  false
 [error]    model exists in catalog : true
 [error]    model id mapping exists:  false
 [error]
 [error]  After
 [error]    model exists in catalog:  true
 [error]      expected:               true
 [error]
 [error]    model id mapping exists:  false
 [error]      expected:               false
 [error]
 [error]    exception thrown:         None
 [error]      expected:               Some
</code></pre></div></div>

<p>This reporting is all done in the <code class="highlighter-rouge">checkState</code> method which is:</p>

<ul>
  <li>doing the comparison between actual and expected values</li>
  <li>displaying the before / after states</li>
  <li>displaying the difference between expected and actual values</li>
</ul>

<p>Actually I even enhanced the display of actual/expected values by coloring them in green or red in the console, using one of specs2 helper
 classes <code class="highlighter-rouge">org.specs2.text.AnsiColors</code>:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">org.specs2.text.AnsiColors</span>

<span class="k">def</span> <span class="n">withColor</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">actual</span><span class="k">:</span> <span class="kt">A</span><span class="o">,</span> <span class="n">expected</span><span class="k">:</span> <span class="kt">A</span><span class="o">,</span> <span class="n">condition</span><span class="k">:</span> <span class="o">(</span><span class="kt">A</span><span class="o">,</span> <span class="kt">A</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Boolean</span> <span class="k">=</span> <span class="o">(</span><span class="n">a</span><span class="k">:</span><span class="kt">A</span><span class="o">,</span> <span class="n">e</span><span class="k">:</span><span class="kt">A</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">a</span> <span class="o">==</span> <span class="n">e</span><span class="o">)</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span>
  <span class="c1">// color the expected value in green or red, depending on the test success
</span>  <span class="n">color</span><span class="o">(</span><span class="n">expected</span><span class="o">.</span><span class="n">toString</span><span class="o">,</span> <span class="k">if</span> <span class="o">(</span><span class="n">condition</span><span class="o">(</span><span class="n">actual</span><span class="o">,</span> <span class="n">expected</span><span class="o">))</span> <span class="n">green</span> <span class="k">else</span> <span class="n">red</span><span class="o">)</span>

<span class="n">withColor</span><span class="o">(</span><span class="n">after</span><span class="o">.</span><span class="n">modelExistsInCatalog</span><span class="o">,</span> <span class="n">expected</span><span class="o">.</span><span class="n">modelExistsInCatalog</span><span class="o">)</span>
</code></pre></div></div>

<p>Both the line numbering and the coloring really helps in fixing issues fast!</p>

<h3 id="replaying-tests">Replaying tests</h3>

<p>A vexing issue with property-based testing is that being random, it will generate random failures every time you re-run a property. So you
can’t re-run a property with the exact same input data. But that was before ScalaCheck 1.14! Now we can pass the seed that is used by the random
 generator to faithfully re-run a failing test. Indeed when a property fails, specs2 will display the current seed value:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[error]  The seed is 1tRQ5-jdfEABEXz1y62Cs0C4vNJQKyXps9eWvbjJPSI=
</code></pre></div></div>

<p>And you can pass this value on the command line to re-run with exactly the failing input data:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sbt&gt; testOnly *ArticleServiceSpec -- scalacheck.seed 1tRQ5-jdfEABEXz1y62Cs0C4vNJQKyXps9eWvbjJPSI=
</code></pre></div></div>

<p>This is super-convenient for debugging!</p>

<h3 id="comments">Comments</h3>

<p>Finally when a given row in the table passes, there is a <code class="highlighter-rouge">comment</code> column to register the reason for this specific outcomes so that future
generations have a sense of <em>why</em> the code is behaving that way. In that sense this whole approach is a bit like having “golden tests” which
are capturing the behaviour of the system as a series of examples</p>

<h3 id="conclusion">Conclusion</h3>

<p>This post shows how we can leverage features from both specs2 and ScalaCheck to make our tests more exhaustive, more readable, more debuggable.
The reality is still more complicated than this:</p>

<ul>
  <li>
    <p>the total number of combinations would make our table very large. So there are actually several tables (one for model creation, one for
 config creation,…) where we assume that some variables are fixed while others can move</p>
  </li>
  <li>
    <p>specs2 datatables are currently limited to 10 columns. The <code class="highlighter-rouge">DataTable</code> code is actually code generated and the latest version only has 10
 columns. One easy first step would be to generate more code (and go up to the magic 22 number for example) or to re-implement this functionality
 as some kind of HList</p>
  </li>
  <li>
    <p>the input state is not trivial to generate because the objects are dependent. The <code class="highlighter-rouge">ModelId</code> of a generated model must be exactly the same
 as the one used in the <code class="highlighter-rouge">Mappings</code> component to register that a model has already been created. So in reality the 2 generators for <code class="highlighter-rouge">Article</code> and
 <code class="highlighter-rouge">Mappings</code> are not totally independent</p>
  </li>
  <li>
    <p>the <code class="highlighter-rouge">Arbitrary</code> instance for <code class="highlighter-rouge">Article</code> can give us articles with 5 <code class="highlighter-rouge">Configs</code> and 10 <code class="highlighter-rouge">Simples</code> but for this test, one <code class="highlighter-rouge">Config</code> and one <code class="highlighter-rouge">Simple</code>
  are enough. Unfortunately we miss a nice language to express those generation condition and easily tweak the default <code class="highlighter-rouge">Arbitrary[Article]</code> (I
  will explore a solution to this problem during the next Haskell eXchange)</p>
  </li>
  <li>
    <p>why are we even using ScalaCheck to generate all the cases since we already statically know all the possible 16 input conditions? We could
  invert this relation and have a ScalaCheck property generated for each row of the datatable with some arbitrary data for the model (and some
fixed data given by the current row). This would not necessarily lead to easier code to implement.</p>
  </li>
</ul>

<p>Anyway despite those remaining questions and issues I hope this post gives you some new ideas on how to be more effective when writing tests
  with specs2 and ScalaCheck, please comment on your own experiments!</p>


<h2>Licensing</h2>
<p>
  Unless otherwise noted, all content is licensed under a <a href="https://creativecommons.org/licenses/by/3.0/deed.en_US">Creative Commons Attribution 3.0 Unported License</a>.
</p>


  <div class="post__author js-fade-in">
    
    
      
        <img class="portrait" src="/img/media/speakers/etorreborre.jpg" />
      
      <p>by Eric Torreborre
    
    on Jul 12, 2018</p>

    
  <a href="https://twitter.com/etorreborre" class="twitter-follow-button" data-show-count="false" data-dnt="true">Follow @etorreborre</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


  <a class="github-button" href="https://github.com/etorreborre" aria-label="Follow @etorreborre on GitHub">Follow @etorreborre</a>
  <script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>


  </div>
  <a class="btn text" href="/blog">Back to blog</a>

  <br style="clear:both;">
<div class="disqus-container" style="padding-top:1em;">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'typelevel'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

</div>



    </div>

    <div class="footer">
      <div class="wrapper">
        <p>Copyright &copy; 2013-2018 the <a href="/">typelevel.org</a> <a href="/contributors.html">contributors</a>.</p>
        <ul class="navigation">
          <li><a href="/projects">Projects</a></li>
          <li><a href="/events">Events</a></li>
          <li><a href="/blog">Blog</a></li>
          <li><a href="/about">About</a></li>
        </ul>
      </div>
    </div>
    
  <!-- Salvattore.js for the masonry layout -->
  <script type="text/javascript" src="/js/salvattore.min.js"></script>
  <!-- Salvattore.js for the masonry layout -->
  </body>
</html>
