<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Typelevel.scala | Refactoring with Monads</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Let the Scala compiler work for you. We provide type classes, instances, conversions, testing, supplements to the standard library, and much more.">


    <link rel="mask-icon" href="/img/favicon-safari.svg" color="#F51C2B">
    <link href="/img/favicon.png" rel="icon" type="image/x-icon">
    <link rel="alternate" href="/blog/feed.rss" title="RSS feed" type="application/rss+xml">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">
    <link href='https://fonts.googleapis.com/css?family=Droid+Serif:400,400italic,700' rel='stylesheet' type='text/css'>

    <script type="text/javascript" src="/js/jquery.min.js"></script>
    <script type="text/javascript" src="/js/app.js"></script>
  </head>
  <body class="no-js ">
    <div class="header">
      <div class="wrapper">
        <a href="/">
          <div class="header__logo">
            Typelevel.scala
          </div>
        </a>
        <a href="#" class="header__menu">
          Menu
        </a>
        <ul class="navigation" role="navigation">
          <li >
            <a href="/projects/">Projects</a>
          </li>
          <li >
            <a href="/events/">Events</a>
          </li>
          <li  class="active" >
            <a href="/blog/">Blog</a>
          </li>
          <li >
            <a href="/about.html">About</a>
          </li>
        </ul>
      </div>
    </div>
    
    <div class="wrapper">
      <div class="content post js-fade-in">
  <h2>Refactoring with Monads</h2>

  <p>I was recently cleaning up some Scala code I’d written a few months
ago when I realized I had been structuring code in a very confusing
way for a very long time. At work, we’ve been trying to untangle the
knots of code that get written by different authors at different
times, as requirements inevitably evolve. We all know that code should
be made up of short, easily digestible functions but we don’t always
get guidance on how to achieve that. In the presence of error handling
and nested data structures, the problem gets even harder.</p>

<p>The goal of this blog post is to describe a concrete strategy for
structuring code so that the overall flow of control is clear to the
reader, even months later; and so the smaller pieces are both
digestible and testable. I’ll start by giving an example function,
operating on some nested data types. Then I’ll explore some ways to
break it into smaller pieces. The key insight is that we can use
computational effects in the form of
<a href="https://typelevel.org/cats/typeclasses/monad.html">monads</a> (more
specifically,
<a href="https://typelevel.org/cats/api/cats/MonadError.html">MonadError</a>) to
wrap smaller pieces and ultimately, compose them into an
understandable sequence of computations.</p>

<h3 id="example-domain-reading-a-catalog">Example domain: reading a catalog</h3>

<p>Let’s not worry about <code class="highlighter-rouge">MonadError</code> yet, but instead look at some
example code. Consider a situation where you need to translate data
from one domain model to another one with different restrictions, and
controlled vocabularies. This can happen in a number of places in a
program, for instance reading a database or an HTTP request to
construct a domain object.</p>

<p>Suppose we need to read an object from a relational database.
Unfortunately, rows in the table may represent objects of a variety of
types so we have to read the row and build up the object graph
accordingly. This is the boundary between the weakly typed wilderness
and the strongly typed world within our program.</p>

<p>Say our database table represents a library catalog, which might have
print books and ebooks. We’d like to look up a book by ID and get back
a nicely typed record.</p>

<p>Here’s a simple table</p>

<table>
  <thead>
    <tr>
      <th>id</th>
      <th>title</th>
      <th>author</th>
      <th>format</th>
      <th>download_type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>45</td>
      <td>Programming In Haskell</td>
      <td>Hutton, Graham</td>
      <td>print</td>
      <td>null</td>
    </tr>
    <tr>
      <td>46</td>
      <td>Programming In Haskell</td>
      <td>Hutton, Graham</td>
      <td>ebook</td>
      <td>epub</td>
    </tr>
    <tr>
      <td>49</td>
      <td>Programming In Haskell</td>
      <td>Hutton, Graham</td>
      <td>ebook</td>
      <td>pdf</td>
    </tr>
  </tbody>
</table>

<p>We can define a simple domain model:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Format</span>
<span class="k">case</span> <span class="k">object</span> <span class="nc">Print</span> <span class="k">extends</span> <span class="nc">Format</span>
<span class="k">case</span> <span class="k">object</span> <span class="nc">Digital</span> <span class="k">extends</span> <span class="nc">Format</span>
<span class="k">object</span> <span class="nc">Format</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">fromString</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Try</span><span class="o">[</span><span class="kt">Format</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
<span class="o">}</span>

<span class="k">sealed</span> <span class="k">trait</span> <span class="nc">DownloadType</span>
<span class="k">case</span> <span class="k">object</span> <span class="nc">Epub</span> <span class="k">extends</span> <span class="nc">DownloadType</span>
<span class="k">case</span> <span class="k">object</span> <span class="nc">Pdf</span> <span class="k">extends</span> <span class="nc">DownloadType</span>
<span class="k">object</span> <span class="nc">DownloadType</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">fromString</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Try</span><span class="o">[</span><span class="kt">DownloadType</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
<span class="o">}</span>

<span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Book</span> <span class="k">extends</span> <span class="nc">Product</span> <span class="k">with</span> <span class="nc">Serializable</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">id</span><span class="k">:</span> <span class="kt">Int</span>
  <span class="k">def</span> <span class="n">title</span><span class="k">:</span> <span class="kt">String</span>
  <span class="k">def</span> <span class="n">author</span><span class="k">:</span> <span class="kt">String</span>
  <span class="k">def</span> <span class="n">format</span><span class="k">:</span> <span class="kt">Format</span>
<span class="o">}</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">PrintBook</span><span class="o">(</span>
    <span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span>
    <span class="n">title</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
    <span class="n">author</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
<span class="o">)</span> <span class="k">extends</span> <span class="nc">Book</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">val</span> <span class="n">format</span><span class="k">:</span> <span class="kt">Format</span> <span class="o">=</span> <span class="nc">Print</span>
<span class="o">}</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">EBook</span><span class="o">(</span>
    <span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span>
    <span class="n">title</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
    <span class="n">author</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
    <span class="n">downloadType</span><span class="k">:</span> <span class="kt">DownloadType</span>
<span class="o">)</span> <span class="k">extends</span> <span class="nc">Book</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">val</span> <span class="n">format</span><span class="k">:</span> <span class="kt">Format</span> <span class="o">=</span> <span class="nc">Digital</span>
<span class="o">}</span>

</code></pre></div></div>

<p>We want to be able to define a method such as:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">findBookById</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Try</span><span class="o">[</span><span class="kt">Book</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
</code></pre></div></div>

<h3 id="monolithic-function">Monolithic function</h3>
<p>One trivial definition of <code class="highlighter-rouge">findBookById</code> might be:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">scala.util.</span><span class="o">{</span><span class="nc">Failure</span><span class="o">,</span> <span class="nc">Success</span><span class="o">,</span> <span class="nc">Try</span><span class="o">}</span>

<span class="k">def</span> <span class="n">findBookById</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Try</span><span class="o">[</span><span class="kt">Book</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="c1">// unsafeQueryUnique returns a `Try[Row]`
</span>  <span class="nc">DB</span><span class="o">.</span><span class="n">unsafeQueryUnique</span><span class="o">(</span><span class="n">sql</span><span class="s">"""select * from catalog where id = $id"""</span><span class="o">).</span><span class="n">flatMap</span> <span class="o">{</span> <span class="n">row</span> <span class="k">=&gt;</span>
    <span class="c1">// pick out the properties every book possesses
</span>    <span class="k">val</span> <span class="n">id</span> <span class="k">=</span> <span class="n">row</span><span class="o">[</span><span class="kt">Int</span><span class="o">](</span><span class="s">"id"</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">title</span> <span class="k">=</span> <span class="n">row</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">"title"</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">author</span> <span class="k">=</span> <span class="n">row</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">"author"</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">formatStr</span> <span class="k">=</span> <span class="n">row</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">"format"</span><span class="o">)</span>

    <span class="c1">// now start to determine the types - get the format first
</span>    <span class="nc">Format</span><span class="o">.</span><span class="n">fromString</span><span class="o">(</span><span class="n">formatStr</span><span class="o">).</span><span class="n">flatMap</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Print</span> <span class="k">=&gt;</span>
        <span class="c1">// for print books, we can construct the book and return immediately
</span>        <span class="nc">Success</span><span class="o">(</span><span class="nc">PrintBook</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">title</span><span class="o">,</span> <span class="n">author</span><span class="o">))</span>
      <span class="k">case</span> <span class="nc">Digital</span> <span class="k">=&gt;</span>
        <span class="c1">// for digital books we need to handle the download type
</span>        <span class="n">row</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]](</span><span class="s">"download_type"</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
          <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span>
            <span class="nc">Failure</span><span class="o">(</span><span class="k">new</span> <span class="nc">AssertionError</span><span class="o">(</span><span class="n">s</span><span class="s">"download type not provided for digital book $id"</span><span class="o">))</span>
          <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">downloadStr</span><span class="o">)</span> <span class="k">=&gt;</span>
            <span class="nc">DownloadType</span><span class="o">.</span><span class="n">fromString</span><span class="o">(</span><span class="n">downloadStr</span><span class="o">).</span><span class="n">flatMap</span> <span class="o">{</span> <span class="n">dt</span> <span class="k">=&gt;</span>
              <span class="nc">Success</span><span class="o">(</span><span class="nc">EBook</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">title</span><span class="o">,</span> <span class="n">author</span><span class="o">,</span> <span class="n">dt</span><span class="o">))</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Depending on your perspective, that is arguably a long function. If
you think it is not so long, pretend that the table has a number of
other fields that must also be conditionally parsed to construct a
<code class="highlighter-rouge">Book</code>.</p>

<h3 id="tail-refactoring">Tail refactoring</h3>
<p>One possible approach is a a strategy I’m going to call
“tail-refactoring”, for lack of a better description. Basically, each
function does a little work or some error checking, and then calls the
next appropriate function in the chain.</p>

<p>You can imagine what kind of code will result. The functions are
smaller, but it’s hard to describe what each function does, and
functions occasionally have to carry along additional parameters that
they will ignore except to pass deeper into the call chain. Let’s take
a look at an example refactoring:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">scala.util.</span><span class="o">{</span><span class="nc">Failure</span><span class="o">,</span> <span class="nc">Success</span><span class="o">,</span> <span class="nc">Try</span><span class="o">}</span>

<span class="k">def</span> <span class="n">extractEBook</span><span class="o">(</span>
    <span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span>
    <span class="n">title</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
    <span class="n">author</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
    <span class="n">downloadTypeStrOpt</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Try</span><span class="o">[</span><span class="kt">EBook</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">downloadTypeStrOpt</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="nc">Failure</span><span class="o">(</span><span class="k">new</span> <span class="nc">AssertionError</span><span class="o">())</span>
    <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">downloadTypeStr</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="nc">DownloadType</span><span class="o">.</span><span class="n">fromString</span><span class="o">(</span><span class="n">downloadTypeStr</span><span class="o">).</span><span class="n">flatMap</span> <span class="o">{</span> <span class="n">dt</span> <span class="k">=&gt;</span>
        <span class="nc">Success</span><span class="o">(</span><span class="nc">EBook</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">title</span><span class="o">,</span> <span class="n">author</span><span class="o">,</span> <span class="n">dt</span><span class="o">))</span>
      <span class="o">}</span>
  <span class="o">}</span>

<span class="k">def</span> <span class="n">extractBook</span><span class="o">(</span>
    <span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span>
    <span class="n">title</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
    <span class="n">author</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
    <span class="n">formatStr</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
    <span class="n">downloadTypeStrOpt</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Try</span><span class="o">[</span><span class="kt">Book</span><span class="o">]</span> <span class="k">=</span>
  <span class="nc">Format</span><span class="o">.</span><span class="n">fromString</span><span class="o">(</span><span class="n">formatStr</span><span class="o">).</span><span class="n">flatMap</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Print</span> <span class="k">=&gt;</span>
      <span class="nc">Success</span><span class="o">(</span><span class="nc">PrintBook</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">title</span><span class="o">,</span> <span class="n">author</span><span class="o">))</span>
    <span class="k">case</span> <span class="nc">Digital</span> <span class="k">=&gt;</span>
      <span class="n">extractEBook</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">title</span><span class="o">,</span> <span class="n">author</span><span class="o">,</span> <span class="n">downloadTypeStrOpt</span><span class="o">)</span>
  <span class="o">}</span>

<span class="k">def</span> <span class="n">findBookById</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Try</span><span class="o">[</span><span class="kt">Book</span><span class="o">]</span> <span class="k">=</span>
  <span class="nc">DB</span><span class="o">.</span><span class="n">unsafeQueryUnique</span><span class="o">(</span><span class="n">sql</span><span class="s">"""select * from catalog where id = $id"""</span><span class="o">).</span><span class="n">flatMap</span> <span class="o">{</span> <span class="n">row</span> <span class="k">=&gt;</span>
    <span class="k">val</span> <span class="n">id</span> <span class="k">=</span> <span class="n">row</span><span class="o">[</span><span class="kt">Int</span><span class="o">](</span><span class="s">"id"</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">title</span> <span class="k">=</span> <span class="n">row</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">"title"</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">author</span> <span class="k">=</span> <span class="n">row</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">"author"</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">formatStr</span> <span class="k">=</span> <span class="n">row</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">"format"</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">downloadTypeStr</span> <span class="k">=</span> <span class="n">row</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]](</span><span class="s">"download_type"</span><span class="o">)</span>
    <span class="n">extractBook</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">title</span><span class="o">,</span> <span class="n">author</span><span class="o">,</span> <span class="n">formatStr</span><span class="o">,</span> <span class="n">downloadTypeStr</span><span class="o">)</span>
  <span class="o">}</span>
</code></pre></div></div>

<p>As you can see, this form has more manageably-sized functions,
although they are still a little long. You can also see that the flow
of control is distributed through all three functions, which means
understanding the logic enough to modify or test it requires
understanding all three functions both individually and as a whole. To
follow the logic, we must trace the functions like a recursive descent
parser.</p>

<h3 id="refactoring-with-monads">Refactoring with Monads</h3>
<p>Without throwing exceptions and catching them at the top, it’s going
to be hard to do substantially better than the “tail-refactoring”
approach, unless we start to make use of the fact that we’re working
with <code class="highlighter-rouge">Try</code>, a data type that supports <code class="highlighter-rouge">flatMap</code>. More precisely, <code class="highlighter-rouge">Try</code>
has a monad instance - recall that monads let us model computational
effects that take place in sequence.</p>

<p>Let’s try to factor out smaller functions, each returning <code class="highlighter-rouge">Try</code>, and
then use a for-comprehension to specify the sequence of operations:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">scala.util.</span><span class="o">{</span><span class="nc">Failure</span><span class="o">,</span> <span class="nc">Success</span><span class="o">,</span> <span class="nc">Try</span><span class="o">}</span>

<span class="k">def</span> <span class="n">parseDownloadType</span><span class="o">(</span><span class="n">o</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span> <span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Try</span><span class="o">[</span><span class="kt">DownloadType</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="n">o</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="nc">DownloadType</span><span class="o">.</span><span class="n">fromString</span><span class="o">)</span>
    <span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="nc">Failure</span><span class="o">(</span><span class="k">new</span> <span class="nc">AssertionError</span><span class="o">(</span><span class="n">s</span><span class="s">"download type not provided for digital book $id"</span><span class="o">)))</span>
<span class="o">}</span>

<span class="k">def</span> <span class="n">findBookById</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Try</span><span class="o">[</span><span class="kt">Book</span><span class="o">]</span> <span class="k">=</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="n">row</span> <span class="k">&lt;-</span> <span class="nc">DB</span><span class="o">.</span><span class="n">unsafeQueryUnique</span><span class="o">(</span><span class="n">sql</span><span class="s">"""select * from catalog where id = $id"""</span><span class="o">)</span>
    <span class="n">format</span> <span class="k">&lt;-</span> <span class="nc">Format</span><span class="o">.</span><span class="n">fromString</span><span class="o">(</span><span class="n">row</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">"format"</span><span class="o">))</span>
    <span class="n">id</span> <span class="k">=</span> <span class="n">row</span><span class="o">[</span><span class="kt">Int</span><span class="o">](</span><span class="s">"id"</span><span class="o">)</span>
    <span class="n">title</span> <span class="k">=</span> <span class="n">row</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">"title"</span><span class="o">)</span>
    <span class="n">author</span> <span class="k">=</span> <span class="n">row</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">"author"</span><span class="o">)</span>
    <span class="n">book</span> <span class="k">&lt;-</span> <span class="n">format</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Print</span> <span class="k">=&gt;</span>
        <span class="nc">Success</span><span class="o">(</span><span class="nc">PrintBook</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">title</span><span class="o">,</span> <span class="n">author</span><span class="o">))</span>
      <span class="k">case</span> <span class="nc">Digital</span> <span class="k">=&gt;</span>
        <span class="n">parseDownloadType</span><span class="o">(</span><span class="n">row</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]](</span><span class="s">"download_type"</span><span class="o">),</span> <span class="n">id</span><span class="o">)</span>
          <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="nc">EBook</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">title</span><span class="o">,</span> <span class="n">author</span><span class="o">,</span> <span class="k">_</span><span class="o">))</span>
    <span class="o">}</span>
  <span class="o">}</span> <span class="k">yield</span> <span class="n">book</span>
</code></pre></div></div>

<p>It’s less code, the functions are smaller, and the top-level function
dictates the entire flow of control. No function takes more than 2
arguments. These are testable, understandable functions. This version
really shows the power of using monads to sequence computation.</p>

<p>Now we are truly making use of the fact that <code class="highlighter-rouge">Try</code> has a monad instance
and not just another container class. We can simply describe the “happy
path” and trust <code class="highlighter-rouge">Try</code> to short-circuit computation if something erroneous
or unexpected occurs. In that case, <code class="highlighter-rouge">Try</code> captures the error and stops
computation there. The code does this without the need for explicit
branching logic.</p>

<h3 id="abstracting-effect-type">Abstracting effect type</h3>
<p>Now, let’s take this one step further - here’s where we achieve
buzzword compliance. Let’s abstract away from the effect, <code class="highlighter-rouge">Try</code>, and
instead make use of
<a href="https://typelevel.org/cats/api/cats/MonadError.html">MonadError</a>.
This lets us use a more diverse set of effect types, from
<a href="https://typelevel.org/cats-effect/datatypes/io.html">IO</a> to
<a href="https://monix.io/docs/3x/eval/task.html">Task</a>, so we can execute our
function in whatever asynchronous context we wish. This has the feel
of a tagless final strategy (although we aren’t worrying about
describing interpreters here).</p>

<p>Here we go:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.MonadError</span>
<span class="k">import</span> <span class="nn">cats.implicits._</span>

<span class="k">def</span> <span class="n">parseDownloadType</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">o</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span> <span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)(</span>
    <span class="k">implicit</span> <span class="n">me</span><span class="k">:</span> <span class="kt">MonadError</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Throwable</span><span class="o">])</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">DownloadType</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="n">me</span><span class="o">.</span><span class="n">fromOption</span><span class="o">(</span><span class="n">o</span><span class="o">,</span> <span class="k">new</span> <span class="nc">AssertionError</span><span class="o">(</span><span class="n">s</span><span class="s">"download type not provided for digital book $id"</span><span class="o">))</span>
    <span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="n">me</span><span class="o">.</span><span class="n">fromTry</span><span class="o">(</span><span class="nc">DownloadType</span><span class="o">.</span><span class="n">fromString</span><span class="o">(</span><span class="n">s</span><span class="o">)))</span>
<span class="o">}</span>

<span class="k">def</span> <span class="n">findBookById</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">me</span><span class="k">:</span> <span class="kt">MonadError</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Throwable</span><span class="o">])</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Book</span><span class="o">]</span> <span class="k">=</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="n">row</span> <span class="k">&lt;-</span> <span class="nc">DB</span><span class="o">.</span><span class="n">queryUnique</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">sql</span><span class="s">"""select * from catalog where id = $id"""</span><span class="o">)</span>
    <span class="n">format</span> <span class="k">&lt;-</span> <span class="n">me</span><span class="o">.</span><span class="n">fromTry</span><span class="o">(</span><span class="nc">Format</span><span class="o">.</span><span class="n">fromString</span><span class="o">(</span><span class="n">row</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">"format"</span><span class="o">)))</span>
    <span class="n">id</span> <span class="k">=</span> <span class="n">row</span><span class="o">[</span><span class="kt">Int</span><span class="o">](</span><span class="s">"id"</span><span class="o">)</span>
    <span class="n">title</span> <span class="k">=</span> <span class="n">row</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">"title"</span><span class="o">)</span>
    <span class="n">author</span> <span class="k">=</span> <span class="n">row</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">"author"</span><span class="o">)</span>
    <span class="n">book</span> <span class="k">&lt;-</span> <span class="n">format</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Print</span> <span class="k">=&gt;</span>
        <span class="n">me</span><span class="o">.</span><span class="n">pure</span><span class="o">(</span><span class="nc">PrintBook</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">title</span><span class="o">,</span> <span class="n">author</span><span class="o">))</span>
      <span class="k">case</span> <span class="nc">Digital</span> <span class="k">=&gt;</span>
        <span class="n">parseDownloadType</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">row</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]](</span><span class="s">"downloadType"</span><span class="o">),</span> <span class="n">id</span><span class="o">)</span>
          <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="nc">EBook</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">title</span><span class="o">,</span> <span class="n">author</span><span class="o">,</span> <span class="k">_</span><span class="o">))</span>
    <span class="o">}</span>
  <span class="o">}</span> <span class="k">yield</span> <span class="n">book</span>
</code></pre></div></div>

<p>The code isn’t much more complicated than the version using <code class="highlighter-rouge">Try</code> but
it adds a lot of flexibility. In a synchronous context, we could still
use <code class="highlighter-rouge">Try</code>. In that case, however, the database call is executed
eagerly, which means the function isn’t referentially transparent. We
can make the function referentially transparent by using a monad such
as <code class="highlighter-rouge">IO</code> or <code class="highlighter-rouge">Task</code> as the effect type and delaying the evaluation of
the database call until “the end of the universe”.</p>

<p>In this example, pay attention to the use of
<a href="https://typelevel.github.io/cats/api/cats/syntax/ApplicativeErrorExtensionOps.html#fromOption[A](oa:Option[A],ifEmpty:=%3EE):F[A]">fromOption</a>
and
<a href="https://typelevel.github.io/cats/api/cats/ApplicativeError.html#fromTry[A](t:scala.util.Try[A])(implicitev:Throwable%3C:%3CE):F[A]">fromTry</a>,
which adapt <code class="highlighter-rouge">Option</code> and <code class="highlighter-rouge">Try</code> to <code class="highlighter-rouge">F</code>. If you are using existing APIs
that aren’t already generalized to <code class="highlighter-rouge">MonadError</code> these methods adapt
common error types, but require very little ceremony to use.</p>

<h3 id="refactoring-strategy">Refactoring strategy</h3>

<p>When faced with a similar refactoring problem, consider whether you
can break the problem into a sequence of independently executable
steps, each of which can be wrapped in a monad. If so, begin by
describing the control flow in your refactored function with a monadic
for-comprehension. Don’t define the individual functions that comprise
the steps of the for-comprehension until you have filled in the
<code class="highlighter-rouge">yield</code> at the end. You can use pseudocode or stubs to minimize the
amount of code churn at the beginning. This is a great time to shuffle
steps around and work out exactly what arguments are needed and when,
as well as where they are coming from.</p>

<p>Once the top level function looks plausible, begin implenting the
steps of the for-comprehension. You can replace the stubs or
pseudocode you wrote by refactoring code from your original function.
If the original code did not operate in a monadic context, recall that
you can convert a simple function <code class="highlighter-rouge">A =&gt; B</code> to <code class="highlighter-rouge">F[A] =&gt; F[B]</code> using
<a href="https://typelevel.org/cats/api/cats/Monad.html#lift[A,B](f:A=%3EB):F[A]=%3EF[B]">lift</a>
(thanks,
<a href="https://typelevel.org/cats/typeclasses/functor.html">Functor</a>!). This
makes converting your existing code even easier.</p>

<h3 id="conclusion">Conclusion</h3>
<p>In this post, we have seen how we can use monads as an aid in
refactoring code to improve both readability and testability. We have
also demonstrated that we can do this in many cases without needing to
specify the monad in use <em>a priori</em>. As a result, we gain the
flexibility to choose the appropriate monad for our application,
independently of the program logic.</p>


<h2>Licensing</h2>
<p>
  Unless otherwise noted, all content is licensed under a <a href="https://creativecommons.org/licenses/by/3.0/deed.en_US">Creative Commons Attribution 3.0 Unported License</a>.
</p>


  <div class="post__author js-fade-in">
    
    
      
      <p>by Mark Tomko
    
    on Aug 07, 2018</p>

    
  <a href="https://twitter.com/oxbsharp" class="twitter-follow-button" data-show-count="false" data-dnt="true">Follow @oxbsharp</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


  <a class="github-button" href="https://github.com/mtomko" aria-label="Follow @mtomko on GitHub">Follow @mtomko</a>
  <script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>


  </div>
  <a class="btn text" href="/blog">Back to blog</a>

  <br style="clear:both;">
<div class="disqus-container" style="padding-top:1em;">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'typelevel'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

</div>



    </div>

    <div class="footer">
      <div class="wrapper">
        <p>Copyright &copy; 2013-2018 the <a href="/">typelevel.org</a> <a href="/contributors.html">contributors</a>.</p>
        <ul class="navigation">
          <li><a href="/projects">Projects</a></li>
          <li><a href="/events">Events</a></li>
          <li><a href="/blog">Blog</a></li>
          <li><a href="/about">About</a></li>
        </ul>
      </div>
    </div>
    
  <!-- Salvattore.js for the masonry layout -->
  <script type="text/javascript" src="/js/salvattore.min.js"></script>
  <!-- Salvattore.js for the masonry layout -->
  </body>
</html>
