<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Typelevel.scala | Machinist vs. value classes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Let the Scala compiler work for you. We provide type classes, instances, conversions, testing, supplements to the standard library, and much more.">


    <link rel="mask-icon" href="/img/favicon-safari.svg" color="#F51C2B">
    <link href="/img/favicon.png" rel="icon" type="image/x-icon">
    <link rel="alternate" href="/blog/feed.rss" title="RSS feed" type="application/rss+xml">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">
    <link href='https://fonts.googleapis.com/css?family=Droid+Serif:400,400italic,700' rel='stylesheet' type='text/css'>

    <script type="text/javascript" src="/js/jquery.min.js"></script>
    <script type="text/javascript" src="/js/app.js"></script>
  </head>
  <body class="no-js ">
    <div class="header">
      <div class="wrapper">
        <a href="/">
          <div class="header__logo">
            Typelevel.scala
          </div>
        </a>
        <a href="#" class="header__menu">
          Menu
        </a>
        <ul class="navigation" role="navigation">
          <li >
            <a href="/projects/">Projects</a>
          </li>
          <li >
            <a href="/events/">Events</a>
          </li>
          <li  class="active" >
            <a href="/blog/">Blog</a>
          </li>
          <li >
            <a href="/about.html">About</a>
          </li>
        </ul>
      </div>
    </div>
    
    <div class="wrapper">
      <div class="content post js-fade-in">
  <h2>Machinist vs. value classes</h2>

  <p>This article is about <a href="https://github.com/typelevel/machinist">machinist</a>, a stand-alone project which started out as part of the <a href="https://github.com/non/spire">spire</a> project and has been originally published in <a href="https://gist.github.com/non/a6ff3c0796e566db20d1">October 2014</a>.
The original description can be found on <a href="/blog/2013/10/13/spires-ops-macros.html">this blog</a>.
You should read that linked post first if you are not familiar with how Machinist works.</p>

<h2 id="introduction">Introduction</h2>

<p><a href="https://github.com/typelevel/machinist/issues/2">Machinist Issue #2</a> asks:</p>

<blockquote>
  <p>Is it correct, that this stuff is completely obsolete now due to
value classes or are there still some use cases? An example of using
value class for zero-cost implicit enrichment: […]</p>
</blockquote>

<p>The short answer is that value classes existed before the Machinist macros were implemented, and they do not solve the same problem Machinist solves.</p>

<p>This article is the long answer.</p>

<h2 id="the-base-case">The base case</h2>

<p>The Machinist’s goal is to remove <em>any</em> overhead that would distinguish
using a type class “directly” from using it indirectly via an implicit
operator.</p>

<p>Imagine we have the following “toy” type class:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">Div</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">div</span><span class="o">(</span><span class="n">lhs</span><span class="k">:</span> <span class="kt">A</span><span class="o">,</span> <span class="n">rhs</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Div</span> <span class="o">{</span>
  <span class="k">implicit</span> <span class="k">val</span> <span class="nc">DivString</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Div</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">div</span><span class="o">(</span><span class="n">lhs</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">rhs</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">lhs</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">rhs</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>This allows us to write generic code such as:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Test1</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">gen</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">x</span><span class="k">:</span> <span class="kt">A</span><span class="o">,</span> <span class="n">y</span><span class="k">:</span> <span class="kt">A</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">ev</span><span class="k">:</span> <span class="kt">Div</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">div</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span>
  <span class="k">def</span> <span class="n">test</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">gen</span><span class="o">(</span><span class="s">"foo"</span><span class="o">,</span> <span class="s">"bar"</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>We have a generic method <code class="highlighter-rouge">gen</code> that works with any type we have a <code class="highlighter-rouge">Div[A]</code> instance for, and we verify that it works using a <code class="highlighter-rouge">test</code> method that operates on some strings. So far, so good. But obviously, calling <code class="highlighter-rouge">ev.div</code> is a bit ugly.</p>

<h2 id="implicit-conversion-with-a-value-class">Implicit conversion with a value class</h2>

<p>We can make the <code class="highlighter-rouge">gen</code> method look a bit nicer by using an implicit conversion. Here’s the code:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">Test3</span> <span class="o">{</span>
  <span class="k">implicit</span> <span class="k">class</span> <span class="nc">DivOps</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="k">val</span> <span class="n">lhs</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">AnyVal</span> <span class="o">{</span>
    <span class="k">def</span> <span class="o">/(</span><span class="n">rhs</span><span class="k">:</span> <span class="kt">A</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">ev</span><span class="k">:</span> <span class="kt">Div</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">div</span><span class="o">(</span><span class="n">lhs</span><span class="o">,</span> <span class="n">rhs</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">Test3</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">Test3.DivOps</span>
  <span class="k">def</span> <span class="n">gen</span><span class="o">[</span><span class="kt">A:</span> <span class="kt">Div</span><span class="o">](</span><span class="n">x</span><span class="k">:</span> <span class="kt">A</span><span class="o">,</span> <span class="n">y</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">y</span>
  <span class="k">def</span> <span class="n">test</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">gen</span><span class="o">(</span><span class="s">"foo"</span><span class="o">,</span> <span class="s">"bar"</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Now, we can just say <code class="highlighter-rouge">x / y</code> and have that call <code class="highlighter-rouge">Div#div</code> automatically. We also don’t need a reference to <code class="highlighter-rouge">ev: Div[A]</code> so we can use the nicer <code class="highlighter-rouge">[A: Div]</code> syntax.</p>

<p>With a normal implicit conversion, every call to <code class="highlighter-rouge">gen</code> would construct an instance of <code class="highlighter-rouge">Test3.DivOps</code>. However, since we have defined <code class="highlighter-rouge">Test3.DivOps</code> as a value class (by extending <code class="highlighter-rouge">AnyVal</code>), the object instantiation is ellided. Instead, the method call is dispatched to <code class="highlighter-rouge">Test3.DivOps.$div$extension</code> which calls <code class="highlighter-rouge">ev.div</code>.</p>

<p>We often talk about value classes as not having a <em>cost</em>. Since no class is instantiated, we are not required to pay a cost in allocations, but we do still pay a cost in indirection (instead of calling <code class="highlighter-rouge">ev.div</code> directly as in <code class="highlighter-rouge">Test1</code> we have an intermediate extension method).</p>

<p>You can see the difference in the output from <code class="highlighter-rouge">javap</code>.</p>

<p>In the case of <code class="highlighter-rouge">Test1.gen</code>, the call to <code class="highlighter-rouge">ev.div</code> and return are all handled with 5 instructions (8 bytes of bytecode):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// cost.Test1.gen(A, A, Div[A]): A
0: aload_3
1: aload_1
2: aload_2
3: invokeinterface #16,  3           // InterfaceMethod cost/Div.div:(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;
8: areturn
</code></pre></div></div>

<p>In the case of <code class="highlighter-rouge">Test3.gen</code>, there is extra ceremony setting up the companion objects, and a call to the extension method (<code class="highlighter-rouge">$div$extension</code>), which is defined in <code class="highlighter-rouge">Test3.DivOps</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// cost.Test3.gen(A, A, Div[A]): A
0: getstatic     #25                 // Field cost/Test3$DivOps$.MODULE$:Lcost/Test3$DivOps$;
3: getstatic     #16                 // Field cost/Test3$.MODULE$:Lcost/Test3$;
6: aload_1
7: invokevirtual #18                 // Method cost/Test3$.DivOps:(Ljava/lang/Object;)Ljava/lang/Object;
10: aload_2
11: aload_3
12: invokevirtual #28                 // Method cost/Test3$DivOps$.$div$extension:(Ljava/lang/Object;Ljava/lang/Object;Lcost/Div;)Ljava/lang/Object;
15: areturn

// cost.Test3.DivOps.$div$extension(A, A, Div[A]): A
0: aload_3
1: aload_1
2: aload_2
3: invokeinterface #20,  3           // InterfaceMethod cost/Div.div:(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;
8: areturn
</code></pre></div></div>

<p>In fact the bytecode for the extension method is uncannily similar to that of <code class="highlighter-rouge">Test1.gen</code>, but in this case <code class="highlighter-rouge">Test3.gen</code> involves 8 more instructions (15 bytes).</p>

<p>In some cases these bytecode differences might not be significant (for example if the running time of <code class="highlighter-rouge">Div[A].div</code> is expected to dwarf the cost of method dispatch). However, when type classes are used to support primitive operations (such as addition or comparisons) it’s likely that this overhead might be significant.</p>

<h2 id="enter-machinist">Enter machinist</h2>

<p>Machinist is based on a set of macros that were introduced in <a href="https://github.com/non/spire">Spire</a> to remove the performance penalties associated with generic math implementations. These macros were based on an even earlier approach which used a compiler plugin.</p>

<p>The basic approach has not changed: at compile-time we can detect situations where we build an object just to assemble a method call with the arguments to its constructor. In these cases we rewrite the tree, removing the object allocation and making the method call directly. Machinist’s documentation goes to some trouble to explain it, but basically, we want to be able to write code like <code class="highlighter-rouge">Test3.gen</code> but have it interpreted as <code class="highlighter-rouge">Test1.gen</code>. That is literally the entire purpose of machinist.</p>

<p>Here’s a construction that works for this example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">Test2</span> <span class="o">{</span>
  <span class="k">implicit</span> <span class="k">class</span> <span class="nc">DivOps</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">lhs</span><span class="k">:</span> <span class="kt">A</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">ev</span><span class="k">:</span> <span class="kt">Div</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span> <span class="o">{</span>
    <span class="k">def</span> <span class="o">/(</span><span class="n">rhs</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span> <span class="n">macro</span> <span class="n">machinist</span><span class="o">.</span><span class="nc">DefaultOps</span><span class="o">.</span><span class="n">binop</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">A</span><span class="o">]</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">Test2</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">Test2.DivOps</span>
  <span class="k">def</span> <span class="n">gen</span><span class="o">[</span><span class="kt">A:</span> <span class="kt">Div</span><span class="o">](</span><span class="n">x</span><span class="k">:</span> <span class="kt">A</span><span class="o">,</span> <span class="n">y</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">y</span>
  <span class="k">def</span> <span class="n">test</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">gen</span><span class="o">(</span><span class="s">"foo"</span><span class="o">,</span> <span class="s">"bar"</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>We use the <code class="highlighter-rouge">machinist.DefaultOps</code> object to provide an instance of the <code class="highlighter-rouge">binop</code> macros, which will rewrite <code class="highlighter-rouge">DivOps(x)(ev).$div(y)</code> into <code class="highlighter-rouge">ev.div(x, y)</code>.</p>

<p>Here’s what we end up with in bytecode:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// cost.Test2.gen(A, A, Div[A]): A
0: aload_3
1: aload_1
2: aload_2
3: invokeinterface #26,  3           // InterfaceMethod cost/Div.div:(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;
8: areturn
</code></pre></div></div>

<p>As you can see, the sourcecode for <code class="highlighter-rouge">Test2.gen</code> is identical to <code class="highlighter-rouge">Test3.gen</code>, and the bytecode for <code class="highlighter-rouge">Test2.gen</code> is identical to that of <code class="highlighter-rouge">Test1.gen</code>. Success!</p>

<h2 id="caveats">Caveats</h2>

<p>There are a few caveats that are worth mentioning:</p>

<h3 id="managing-compilation-units">Managing compilation units</h3>

<p>The issue that sparked this article used the operator <code class="highlighter-rouge">+/+</code>. Machinist claims to be able to support any symbolic operator. Why didn’t we use that operator here?</p>

<p>The answer has to do with how Scala macros work. Scala requires that macros be defined in a separate “compilation unit” from the one they are invoked in. This makes it very awkward to create a code snippet that both defines and uses a macro. In this case, it means that we can’t extend <code class="highlighter-rouge">machinist.Ops</code> to define new symbolic operators in the same file that demonstrates their use. This is why we used <code class="highlighter-rouge">/</code> (which maps to <code class="highlighter-rouge">div</code> and is a “default operator”).</p>

<p>You can arrange your “real” projects so that they are not affected by this limitation.</p>

<h3 id="use-outside-of-generic-methods">Use outside of generic methods</h3>

<p>Now that we’ve demonstrated the cost that implicit conversions to value classes impose, you might imagine wanting to perform this transformation on <em>all</em> your implicit conversions.</p>

<p>Unfortunately, Machinist is not sufficiently general to support this. Right now its macros support a number of different “shapes” but assume generic method which dispatches to an implicit evidence parameter. It might be possible to write macros which inline the method body of a concrete implicit class, but that’s outside the scope of the project.</p>

<h2 id="postscript-messy-details">Postscript: messy details</h2>

<p>This article throws around a lot of source code and bytecode.  Below are included the files needed to build the demo (<code class="highlighter-rouge">cost.scala</code> and <code class="highlighter-rouge">build.sbt</code>) as well as the <code class="highlighter-rouge">javap</code> output from the three test classes, and the value class.</p>

<h3 id="costscala">cost.scala</h3>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">cost</span>

<span class="k">import</span> <span class="nn">language.implicitConversions</span>
<span class="k">import</span> <span class="nn">scala.language.experimental.macros</span>

<span class="k">trait</span> <span class="nc">Div</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">div</span><span class="o">(</span><span class="n">lhs</span><span class="k">:</span> <span class="kt">A</span><span class="o">,</span> <span class="n">rhs</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Div</span> <span class="o">{</span>
  <span class="k">implicit</span> <span class="k">val</span> <span class="nc">DivString</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Div</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">div</span><span class="o">(</span><span class="n">lhs</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">rhs</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">lhs</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">rhs</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">Test1</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">gen</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">x</span><span class="k">:</span> <span class="kt">A</span><span class="o">,</span> <span class="n">y</span><span class="k">:</span> <span class="kt">A</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">ev</span><span class="k">:</span> <span class="kt">Div</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">div</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span>
  <span class="k">def</span> <span class="n">test</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">gen</span><span class="o">(</span><span class="s">"foo"</span><span class="o">,</span> <span class="s">"bar"</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Test2</span> <span class="o">{</span>
  <span class="k">implicit</span> <span class="k">class</span> <span class="nc">DivOps</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">lhs</span><span class="k">:</span> <span class="kt">A</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">ev</span><span class="k">:</span> <span class="kt">Div</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span> <span class="o">{</span>
    <span class="k">def</span> <span class="o">/(</span><span class="n">rhs</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span> <span class="n">macro</span> <span class="n">machinist</span><span class="o">.</span><span class="nc">DefaultOps</span><span class="o">.</span><span class="n">binop</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">A</span><span class="o">]</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">Test2</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">Test2.DivOps</span>
  <span class="k">def</span> <span class="n">gen</span><span class="o">[</span><span class="kt">A:</span> <span class="kt">Div</span><span class="o">](</span><span class="n">x</span><span class="k">:</span> <span class="kt">A</span><span class="o">,</span> <span class="n">y</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">y</span>
  <span class="k">def</span> <span class="n">test</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">gen</span><span class="o">(</span><span class="s">"foo"</span><span class="o">,</span> <span class="s">"bar"</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Test3</span> <span class="o">{</span>
  <span class="k">implicit</span> <span class="k">class</span> <span class="nc">DivOps</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="k">val</span> <span class="n">lhs</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">AnyVal</span> <span class="o">{</span>
    <span class="k">def</span> <span class="o">/(</span><span class="n">rhs</span><span class="k">:</span> <span class="kt">A</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">ev</span><span class="k">:</span> <span class="kt">Div</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">div</span><span class="o">(</span><span class="n">lhs</span><span class="o">,</span> <span class="n">rhs</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">Test3</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">Test3.DivOps</span>
  <span class="k">def</span> <span class="n">gen</span><span class="o">[</span><span class="kt">A:</span> <span class="kt">Div</span><span class="o">](</span><span class="n">x</span><span class="k">:</span> <span class="kt">A</span><span class="o">,</span> <span class="n">y</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">y</span>
  <span class="k">def</span> <span class="n">test</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">gen</span><span class="o">(</span><span class="s">"foo"</span><span class="o">,</span> <span class="s">"bar"</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="buildsbt">build.sbt</h3>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">name</span> <span class="o">:=</span> <span class="s">"cost"</span>

<span class="n">scalaVersion</span> <span class="o">:=</span> <span class="s">"2.11.2"</span>

<span class="n">resolvers</span> <span class="o">+=</span> <span class="s">"bintray/non"</span> <span class="n">at</span> <span class="s">"http://dl.bintray.com/non/maven"</span>

<span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">"org.typelevel"</span> <span class="o">%%</span> <span class="s">"machinist"</span> <span class="o">%</span> <span class="s">"0.2.2"</span>
</code></pre></div></div>

<h3 id="test1out">Test1.out</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Compiled from "cost.scala"
public class cost.Test1 {
  public &lt;A extends java/lang/Object&gt; A gen(A, A, cost.Div&lt;A&gt;);
    Code:
       0: aload_3       
       1: aload_1       
       2: aload_2       
       3: invokeinterface #16,  3           // InterfaceMethod cost/Div.div:(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;
       8: areturn       

  public java.lang.String test();
    Code:
       0: aload_0       
       1: ldc           #27                 // String foo
       3: ldc           #29                 // String bar
       5: getstatic     #35                 // Field cost/Div$.MODULE$:Lcost/Div$;
       8: invokevirtual #39                 // Method cost/Div$.DivString:()Lcost/Div;
      11: invokevirtual #41                 // Method gen:(Ljava/lang/Object;Ljava/lang/Object;Lcost/Div;)Ljava/lang/Object;
      14: checkcast     #43                 // class java/lang/String
      17: areturn       

  public cost.Test1();
    Code:
       0: aload_0       
       1: invokespecial #47                 // Method java/lang/Object."&lt;init&gt;":()V
       4: return        
}
</code></pre></div></div>

<h3 id="test2out">Test2.out</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Compiled from "cost.scala"
public class cost.Test2 {
  public static &lt;A extends java/lang/Object&gt; cost.Test2$DivOps&lt;A&gt; DivOps(A, cost.Div&lt;A&gt;);
    Code:
       0: getstatic     #16                 // Field cost/Test2$.MODULE$:Lcost/Test2$;
       3: aload_0       
       4: aload_1       
       5: invokevirtual #18                 // Method cost/Test2$.DivOps:(Ljava/lang/Object;Lcost/Div;)Lcost/Test2$DivOps;
       8: areturn       

  public &lt;A extends java/lang/Object&gt; A gen(A, A, cost.Div&lt;A&gt;);
    Code:
       0: aload_3       
       1: aload_1       
       2: aload_2       
       3: invokeinterface #26,  3           // InterfaceMethod cost/Div.div:(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;
       8: areturn       

  public java.lang.String test();
    Code:
       0: aload_0       
       1: ldc           #37                 // String foo
       3: ldc           #39                 // String bar
       5: getstatic     #44                 // Field cost/Div$.MODULE$:Lcost/Div$;
       8: invokevirtual #48                 // Method cost/Div$.DivString:()Lcost/Div;
      11: invokevirtual #50                 // Method gen:(Ljava/lang/Object;Ljava/lang/Object;Lcost/Div;)Ljava/lang/Object;
      14: checkcast     #52                 // class java/lang/String
      17: areturn       

  public cost.Test2();
    Code:
       0: aload_0       
       1: invokespecial #56                 // Method java/lang/Object."&lt;init&gt;":()V
       4: return        
}
</code></pre></div></div>

<h3 id="test3out">Test3.out</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Compiled from "cost.scala"
public class cost.Test3 {
  public static java.lang.Object DivOps(java.lang.Object);
    Code:
       0: getstatic     #16                 // Field cost/Test3$.MODULE$:Lcost/Test3$;
       3: aload_0       
       4: invokevirtual #18                 // Method cost/Test3$.DivOps:(Ljava/lang/Object;)Ljava/lang/Object;
       7: areturn       

  public &lt;A extends java/lang/Object&gt; A gen(A, A, cost.Div&lt;A&gt;);
    Code:
       0: getstatic     #25                 // Field cost/Test3$DivOps$.MODULE$:Lcost/Test3$DivOps$;
       3: getstatic     #16                 // Field cost/Test3$.MODULE$:Lcost/Test3$;
       6: aload_1       
       7: invokevirtual #18                 // Method cost/Test3$.DivOps:(Ljava/lang/Object;)Ljava/lang/Object;
      10: aload_2       
      11: aload_3       
      12: invokevirtual #28                 // Method cost/Test3$DivOps$.$div$extension:(Ljava/lang/Object;Ljava/lang/Object;Lcost/Div;)Ljava/lang/Object;
      15: areturn       

  public java.lang.String test();
    Code:
       0: aload_0       
       1: ldc           #39                 // String foo
       3: ldc           #41                 // String bar
       5: getstatic     #46                 // Field cost/Div$.MODULE$:Lcost/Div$;
       8: invokevirtual #50                 // Method cost/Div$.DivString:()Lcost/Div;
      11: invokevirtual #52                 // Method gen:(Ljava/lang/Object;Ljava/lang/Object;Lcost/Div;)Ljava/lang/Object;
      14: checkcast     #54                 // class java/lang/String
      17: areturn       

  public cost.Test3();
    Code:
       0: aload_0       
       1: invokespecial #58                 // Method java/lang/Object."&lt;init&gt;":()V
       4: return        
}
</code></pre></div></div>

<h3 id="test3divopsout">Test3.DivOps.out</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Compiled from "cost.scala"
public class cost.Test3$DivOps$ {
  public static final cost.Test3$DivOps$ MODULE$;

  public static {};
    Code:
       0: new           #2                  // class cost/Test3$DivOps$
       3: invokespecial #12                 // Method "&lt;init&gt;":()V
       6: return        

  public final &lt;A extends java/lang/Object&gt; A $div$extension(A, A, cost.Div&lt;A&gt;);
    Code:
       0: aload_3       
       1: aload_1       
       2: aload_2       
       3: invokeinterface #20,  3           // InterfaceMethod cost/Div.div:(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;
       8: areturn       

  public final &lt;A extends java/lang/Object&gt; int hashCode$extension(A);
    Code:
       0: aload_1       
       1: invokevirtual #32                 // Method java/lang/Object.hashCode:()I
       4: ireturn       

  public final &lt;A extends java/lang/Object&gt; boolean equals$extension(A, java.lang.Object);
    Code:
       0: aload_2       
       1: astore_3      
       2: aload_3       
       3: instanceof    #36                 // class cost/Test3$DivOps
       6: ifeq          15
       9: iconst_1      
      10: istore        4
      12: goto          18
      15: iconst_0      
      16: istore        4
      18: iload         4
      20: ifeq          61
      23: aload_2       
      24: ifnonnull     31
      27: aconst_null   
      28: goto          38
      31: aload_2       
      32: checkcast     #36                 // class cost/Test3$DivOps
      35: invokevirtual #40                 // Method cost/Test3$DivOps.lhs:()Ljava/lang/Object;
      38: astore        5
      40: aload_1       
      41: aload         5
      43: invokestatic  #45                 // Method scala/runtime/BoxesRunTime.equals:(Ljava/lang/Object;Ljava/lang/Object;)Z
      46: ifeq          53
      49: iconst_1      
      50: goto          54
      53: iconst_0      
      54: ifeq          61
      57: iconst_1      
      58: goto          62
      61: iconst_0      
      62: ireturn       

  public cost.Test3$DivOps$();
    Code:
       0: aload_0       
       1: invokespecial #47                 // Method java/lang/Object."&lt;init&gt;":()V
       4: aload_0       
       5: putstatic     #49                 // Field MODULE$:Lcost/Test3$DivOps$;
       8: return        
}
</code></pre></div></div>


<h2>Licensing</h2>
<p>
  Unless otherwise noted, all content is licensed under a <a href="https://creativecommons.org/licenses/by/3.0/deed.en_US">Creative Commons Attribution 3.0 Unported License</a>.
</p>


  <div class="post__author js-fade-in">
    
    
      
        <img class="portrait" src="/img/media/speakers/erikosheim.jpg" />
      
      <p>by Erik Osheim
    
    on Aug 06, 2015</p>

    
  <a href="https://twitter.com/d6" class="twitter-follow-button" data-show-count="false" data-dnt="true">Follow @d6</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


  <a class="github-button" href="https://github.com/non" aria-label="Follow @non on GitHub">Follow @non</a>
  <script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>


  </div>
  <a class="btn text" href="/blog">Back to blog</a>

  <br style="clear:both;">
<div class="disqus-container" style="padding-top:1em;">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'typelevel'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

</div>



    </div>

    <div class="footer">
      <div class="wrapper">
        <p>Copyright &copy; 2013-2018 the <a href="/">typelevel.org</a> <a href="/contributors.html">contributors</a>.</p>
        <ul class="navigation">
          <li><a href="/projects">Projects</a></li>
          <li><a href="/events">Events</a></li>
          <li><a href="/blog">Blog</a></li>
          <li><a href="/about">About</a></li>
        </ul>
      </div>
    </div>
    
  <!-- Salvattore.js for the masonry layout -->
  <script type="text/javascript" src="/js/salvattore.min.js"></script>
  <!-- Salvattore.js for the masonry layout -->
  </body>
</html>
