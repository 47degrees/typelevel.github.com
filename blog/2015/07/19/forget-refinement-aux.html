<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Typelevel.scala | What happens when I forget a refinement?</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Let the Scala compiler work for you. We provide type classes, instances, conversions, testing, supplements to the standard library, and much more.">


    <link rel="mask-icon" href="/img/favicon-safari.svg" color="#F51C2B">
    <link href="/img/favicon.png" rel="icon" type="image/x-icon">
    <link rel="alternate" href="/blog/feed.rss" title="RSS feed" type="application/rss+xml">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">
    <link href='https://fonts.googleapis.com/css?family=Droid+Serif:400,400italic,700' rel='stylesheet' type='text/css'>

    <script type="text/javascript" src="/js/jquery.min.js"></script>
    <script type="text/javascript" src="/js/app.js"></script>
  </head>
  <body class="no-js ">
    <div class="header">
      <div class="wrapper">
        <a href="/">
          <div class="header__logo">
            Typelevel.scala
          </div>
        </a>
        <a href="#" class="header__menu">
          Menu
        </a>
        <ul class="navigation" role="navigation">
          <li >
            <a href="/projects/">Projects</a>
          </li>
          <li >
            <a href="/events/">Events</a>
          </li>
          <li  class="active" >
            <a href="/blog/">Blog</a>
          </li>
          <li >
            <a href="/about.html">About</a>
          </li>
        </ul>
      </div>
    </div>
    
    <div class="wrapper">
      <div class="content post js-fade-in">
  <h2>What happens when I forget a refinement?</h2>

  <p><em>This is the third of a series of articles on “Type Parameters and
Type Members”.  If you haven’t yet, you should
<a href="/blog/2015/07/13/type-members-parameters.html">start at the beginning</a>,
which introduces code we refer to throughout this article without
further ado.</em></p>

<p>As I mentioned
<a href="/blog/2015/07/16/method-equiv.html#when-are-two-methods-less-alike">in the previous article</a>,
the error of the <code class="highlighter-rouge">mdropFirstE</code> signature, taking <code class="highlighter-rouge">MList</code> and returning
merely <code class="highlighter-rouge">MList</code>, was to fail to relate the input element type to the
output element type.  This mistake is an easy one to make when failure
is the default behavior.</p>

<p>By contrast, <strong>when we try this with <code class="highlighter-rouge">PList</code>, the compiler helpfully
points out our error</strong>.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">pdropFirst</span><span class="o">(</span><span class="n">xs</span><span class="k">:</span> <span class="kt">PList</span><span class="o">)</span><span class="k">:</span> <span class="kt">PList</span> <span class="o">=</span> <span class="o">???</span>

<span class="nc">TmTp3</span><span class="o">.</span><span class="n">scala</span><span class="k">:</span><span class="err">6</span><span class="kt">:</span> <span class="kt">class</span> <span class="kt">PList</span> <span class="kt">takes</span> <span class="k">type</span> <span class="kt">parameters</span>
  <span class="k">def</span> <span class="n">pdropFirst</span><span class="o">(</span><span class="n">xs</span><span class="k">:</span> <span class="kt">PList</span><span class="o">)</span><span class="k">:</span> <span class="kt">PList</span> <span class="o">=</span> <span class="o">???</span>
                             <span class="o">^</span>
<span class="nc">TmTp3</span><span class="o">.</span><span class="n">scala</span><span class="k">:</span><span class="err">6</span><span class="kt">:</span> <span class="kt">class</span> <span class="kt">PList</span> <span class="kt">takes</span> <span class="k">type</span> <span class="kt">parameters</span>
  <span class="k">def</span> <span class="n">pdropFirst</span><span class="o">(</span><span class="n">xs</span><span class="k">:</span> <span class="kt">PList</span><span class="o">)</span><span class="k">:</span> <span class="kt">PList</span> <span class="o">=</span> <span class="o">???</span>
                     <span class="o">^</span>
</code></pre></div></div>

<h2 id="what-happens-when-i-misspell-a-refinement">What happens when I misspell a refinement?</h2>

<p>There is another mistake that type members open you up to. I have been
using the very odd type parameter—and member—name <code class="highlighter-rouge">T</code>.
Java developers will find this choice very ordinary, but the name of
choice for the discerning Scala programmer is <code class="highlighter-rouge">A</code>.  So suppose I
attempted to correct <code class="highlighter-rouge">mdropFirstE</code>’s type as follows:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">mdropFirstE2</span><span class="o">[</span><span class="kt">T0</span><span class="o">](</span><span class="n">xs</span><span class="k">:</span> <span class="kt">MList</span> <span class="o">{</span><span class="k">type</span> <span class="kt">A</span> <span class="o">=</span> <span class="kt">T0</span><span class="o">})</span> <span class="k">=</span>
  <span class="n">xs</span><span class="o">.</span><span class="n">uncons</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="nc">MNil</span><span class="o">()</span>
    <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">c</span><span class="o">.</span><span class="n">tail</span>
  <span class="o">}</span>
</code></pre></div></div>

<p>This method compiles, but I cannot invoke it!</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">mdropFirstE2</span><span class="o">(</span><span class="nc">MNil</span><span class="o">[</span><span class="kt">Int</span><span class="o">]())</span>
<span class="o">&lt;</span><span class="n">console</span><span class="k">&gt;:</span><span class="mi">20</span><span class="k">:</span> <span class="kt">error:</span> <span class="k">type</span> <span class="kt">mismatch</span><span class="o">;</span>
 <span class="n">found</span>   <span class="k">:</span> <span class="kt">tmtp.MNil</span><span class="o">{</span><span class="k">type</span> <span class="kt">T</span> <span class="o">=</span> <span class="kt">Int</span><span class="o">}</span>
 <span class="n">required</span><span class="k">:</span> <span class="kt">tmtp.MList</span><span class="o">{</span><span class="k">type</span> <span class="kt">A</span> <span class="o">=</span> <span class="kt">?</span><span class="o">}</span>
       <span class="n">mdropFirstE2</span><span class="o">(</span><span class="nc">MNil</span><span class="o">[</span><span class="kt">Int</span><span class="o">]())</span>
                             <span class="o">^</span>

<span class="o">&gt;</span> <span class="n">mdropFirstE2</span><span class="o">(</span><span class="nc">MCons</span><span class="o">[</span><span class="kt">Int</span><span class="o">](</span><span class="mi">42</span><span class="o">,</span> <span class="nc">MNil</span><span class="o">[</span><span class="kt">Int</span><span class="o">]()))</span>
<span class="o">&lt;</span><span class="n">console</span><span class="k">&gt;:</span><span class="mi">20</span><span class="k">:</span> <span class="kt">error:</span> <span class="k">type</span> <span class="kt">mismatch</span><span class="o">;</span>
 <span class="n">found</span>   <span class="k">:</span> <span class="kt">tmtp.MCons</span><span class="o">{</span><span class="k">type</span> <span class="kt">T</span> <span class="o">=</span> <span class="kt">Int</span><span class="o">}</span>
 <span class="n">required</span><span class="k">:</span> <span class="kt">tmtp.MList</span><span class="o">{</span><span class="k">type</span> <span class="kt">A</span> <span class="o">=</span> <span class="kt">?</span><span class="o">}</span>
       <span class="n">mdropFirstE2</span><span class="o">(</span><span class="nc">MCons</span><span class="o">[</span><span class="kt">Int</span><span class="o">](</span><span class="mi">42</span><span class="o">,</span> <span class="nc">MNil</span><span class="o">[</span><span class="kt">Int</span><span class="o">]()))</span>
                              <span class="o">^</span>
</code></pre></div></div>

<p>That’s because <code class="highlighter-rouge">MList {type A = T0}</code> is a perfectly reasonable
intersection type: values of this type have <em>both</em> the type <code class="highlighter-rouge">MList</code> in
their supertype tree somewhere, <em>and</em> a type member named <code class="highlighter-rouge">A</code>, which
is bound to <code class="highlighter-rouge">T0</code>.  In terms of subtyping relationships:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">MList</span> <span class="o">{</span><span class="k">type</span> <span class="kt">A</span> <span class="o">=</span> <span class="n">T0</span><span class="o">}</span> <span class="k">&lt;:</span> <span class="nc">MList</span>
<span class="c1">// and unrelatedly,
</span><span class="nc">MList</span> <span class="o">{</span><span class="k">type</span> <span class="kt">A</span> <span class="o">=</span> <span class="n">T0</span><span class="o">}</span> <span class="k">&lt;:</span> <span class="o">{</span><span class="k">type</span> <span class="kt">A</span> <span class="o">=</span> <span class="n">T0</span><span class="o">}</span>
</code></pre></div></div>

<p>That <code class="highlighter-rouge">MList</code> has no such type member <code class="highlighter-rouge">A</code> is irrelevant to the
intersection and refinement of types in Scala.  This type means “an
instance of the trait <code class="highlighter-rouge">MList</code>, with a type member named <code class="highlighter-rouge">A</code> set
to <code class="highlighter-rouge">T0</code>”.  This type member <code class="highlighter-rouge">A</code> could come from another trait mixed
with <code class="highlighter-rouge">MList</code> or an inline subclass.  Whether such a thing is
impossible to instantiate—due to <code class="highlighter-rouge">sealed</code>, <code class="highlighter-rouge">final</code>, or anything
else—is also irrelevant; <strong>types with no values are meaningful and
useful in both Java and Scala</strong>.</p>

<h2 id="why-t0--whats-aux">Why <code class="highlighter-rouge">T0</code>?  What’s <code class="highlighter-rouge">Aux</code>?</h2>

<p>A few of the methods on <code class="highlighter-rouge">MList</code> we have seen so far take a type
parameter <code class="highlighter-rouge">T0</code> instead of <code class="highlighter-rouge">T</code>.  This is just a mnemonic trick; I’m
saying “I would write <code class="highlighter-rouge">T</code> here if <code class="highlighter-rouge">scalac</code> would let me”, which I have
borrowed from
<a href="https://github.com/scalaz/scalaz/blob/v7.1.3/core/src/main/scala/scalaz/Unapply.scala#L217"><code class="highlighter-rouge">scalaz.Unapply</code></a>.
Let’s try to implement <code class="highlighter-rouge">def MNil</code> taking a <code class="highlighter-rouge">T</code> instead.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nc">MNil</span><span class="o">[</span><span class="kt">T</span><span class="o">]()</span><span class="k">:</span> <span class="kt">MNil</span> <span class="o">{</span><span class="k">type</span> <span class="kt">T</span> <span class="o">=</span> <span class="kt">T</span><span class="o">}</span> <span class="k">=</span>
  <span class="k">new</span> <span class="nc">MNil</span> <span class="o">{</span>
    <span class="k">type</span> <span class="kt">T</span> <span class="o">=</span> <span class="n">T</span>
  <span class="o">}</span>

<span class="c1">// Scala complains, though:
</span><span class="nc">TmTp3</span><span class="o">.</span><span class="n">scala</span><span class="k">:</span><span class="err">15</span><span class="kt">:</span> <span class="kt">illegal</span> <span class="kt">cyclic</span> <span class="kt">reference</span> <span class="kt">involving</span> <span class="k">type</span> <span class="kt">T</span>
  <span class="k">def</span> <span class="nc">MNil</span><span class="o">[</span><span class="kt">T</span><span class="o">]()</span><span class="k">:</span> <span class="kt">MNil</span> <span class="o">{</span><span class="k">type</span> <span class="kt">T</span> <span class="o">=</span> <span class="kt">T</span><span class="o">}</span> <span class="k">=</span>
                                <span class="o">^</span>
</code></pre></div></div>

<p>This is a scoping problem; the refinement type makes the member <code class="highlighter-rouge">T</code>
shadow our method type parameter <code class="highlighter-rouge">T</code>.  We dealt with the problem in
<code class="highlighter-rouge">MList#uncons</code> and <code class="highlighter-rouge">MCons#tail</code> as well, way back in section “Two
lists, all alike” of
<a href="/blog/2015/07/13/type-members-parameters.html#two-lists-all-alike">the first part</a>,
in those cases by outer-scoping the <code class="highlighter-rouge">T</code> as
<code class="highlighter-rouge">self.T</code> instead.</p>

<p><strong>When defining a type with members, you should define an <code class="highlighter-rouge">Aux</code> type
in your companion that converts the member to a type parameter.</strong> The
name <code class="highlighter-rouge">Aux</code> is a convention I have borrowed from
<a href="https://github.com/milessabin/shapeless/blob/shapeless-2.2.4/core/src/main/scala/shapeless/ops/hlists.scala#L1501">Shapeless ops</a>.
This is pretty much boilerplate; in this case, add this to
<code class="highlighter-rouge">object MList</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="kt">Aux</span><span class="o">[</span><span class="kt">T0</span><span class="o">]</span> <span class="k">=</span> <span class="nc">MList</span> <span class="o">{</span><span class="k">type</span> <span class="kt">T</span> <span class="o">=</span> <span class="n">T0</span><span class="o">}</span>
</code></pre></div></div>

<p>Now you can write <code class="highlighter-rouge">MList.Aux[Int]</code> instead of <code class="highlighter-rouge">MList {type T = Int}</code>.
Here’s <code class="highlighter-rouge">mdropFirstT</code>’s signature rewritten in this style.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">mdropFirstT2</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">xs</span><span class="k">:</span> <span class="kt">MList.Aux</span><span class="o">[</span><span class="kt">T</span><span class="o">])</span><span class="k">:</span> <span class="kt">MList.Aux</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>
</code></pre></div></div>

<p>Furthermore, because the member <code class="highlighter-rouge">T</code> is not in scope for <code class="highlighter-rouge">Aux</code>’s type
parameter position, you can take method type parameters named <code class="highlighter-rouge">T</code> and
sensibly write <code class="highlighter-rouge">MList.Aux[T]</code> without the above error.  You can see
this in the immediately preceding example.  But, stepping back a bit,
this should be considered an advantage for type parameters more
generally; <code class="highlighter-rouge">PList</code> doesn’t have this problem in the first place.</p>

<p><strong>Using <code class="highlighter-rouge">Aux</code> also helps you avoid the errors of forgetting to specify
or misspelling a type member</strong>, as described at the beginning of this
article.  With <code class="highlighter-rouge">Aux</code>, as with ordinary parameterized types, a missing
argument is caught by the compiler, and misspelling the parameter name
is impossible.</p>

<p>In
<a href="/blog/2015/07/23/type-projection.html">the next part, “Type projection isn’t that specific”</a>,
we’ll see why something that, at first glance, seems
like a workable alternative to either refinement or the <code class="highlighter-rouge">Aux</code> trick,
doesn’t work out as well as people wish it would.</p>

<p><em>This article was tested with Scala 2.11.7.</em></p>


<h2>Licensing</h2>
<p>
  Unless otherwise noted, all content is licensed under a <a href="https://creativecommons.org/licenses/by/3.0/deed.en_US">Creative Commons Attribution 3.0 Unported License</a>.
</p>


  <div class="post__author js-fade-in">
    
    
      
      <p>by Stephen Compall
    
    on Jul 19, 2015</p>

    
  <a href="https://twitter.com/S11001001" class="twitter-follow-button" data-show-count="false" data-dnt="true">Follow @S11001001</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


  <a class="github-button" href="https://github.com/S11001001" aria-label="Follow @S11001001 on GitHub">Follow @S11001001</a>
  <script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>


  </div>
  <a class="btn text" href="/blog">Back to blog</a>

  <br style="clear:both;">
<div class="disqus-container" style="padding-top:1em;">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'typelevel'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

</div>



    </div>

    <div class="footer">
      <div class="wrapper">
        <p>Copyright &copy; 2013-2018 the <a href="/">typelevel.org</a> <a href="/contributors.html">contributors</a>.</p>
        <ul class="navigation">
          <li><a href="/projects">Projects</a></li>
          <li><a href="/events">Events</a></li>
          <li><a href="/blog">Blog</a></li>
          <li><a href="/about">About</a></li>
        </ul>
      </div>
    </div>
    
  <!-- Salvattore.js for the masonry layout -->
  <script type="text/javascript" src="/js/salvattore.min.js"></script>
  <!-- Salvattore.js for the masonry layout -->
  </body>
</html>
